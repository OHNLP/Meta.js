
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>Pairwise Meta-Analysis Plots</title>

<link rel="shortcut icon" href="./favicon.ico">
<!-- <script src="https://kit.fontawesome.com/cb45cc91b0.js" crossorigin="anonymous"></script> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />


<style>
/**
 * My Box Style
 * This style is for showing more items on one page.
 */
 .d-flex {
    display: flex;
}
.fx-row {
    flex-direction: row;
}
.fx-col {
    flex-direction: column;
}
.fx-jc-space-between {
    justify-content: space-between;
}
/* box */
.box {
    display: flex;
    flex-direction: column;
    width: 100%;
    font-size: 12px;
    font-family: Arial, Helvetica, sans-serif;
}
.box-header {
    width: 100%;
    padding: 3px 0;
    display: flex;
    flex-direction: row;
}
.box-header-grey {
    background-color: #efefef;
}
.box-header a {
    font-size: .8em;
}
.box-header h4 {
    padding: 0;
    margin: 0;
    font-size: .95em;
    height: 1.6em;
    line-height: 1.6em;
    margin: 3px 0;
}
.box-header button, 
.box-body button, 
.box-footer button {
    height: 1.6em;
    line-height: 1em;
    font-size: .8em;
    margin: 4px;
}
.box-header input,
.box-body input {
    height: 1em;
    line-height: 1em;
    font-size: 1em;
    margin: 4px 4px 0 4px;
}
.box-input {
    border: 0;
    padding: 2px 3px;
    border-bottom: 1px solid #333333;
}
.box-menu-group {
    margin: 0 10px;
}
.box-menu-group div {
    height: 1.6em;
    line-height: 2em;
}
.box-menu-link {
    text-decoration: underline;
    cursor: pointer !important;
}
.box-menu-link:hover {
    font-weight: bold;
}
.box-radio-group {
    margin: 0 10px;
}
.box-radio-item {
    padding: 0 5px;
    display: flex;
    align-items: center;
}
.box-radio-item:hover {
    background-color: whitesmoke;
} 
.box-radio-group div {
    height: 1.6em;
    line-height: 2em;
}
.box-radio-item label {
    height: 1.6em;
}
.box-header select {
    height: 1.6em;
    line-height: 1.2em;
    font-size: 1em;
    margin: 0 4px;
}
.box-header p {
    height: 1.6em;
    line-height: 1.2em;
    font-size: 1em;
    margin: 5px 0 0 2px;
}
.box-header span {
    font-size: .9em;
}
.box-header-right {
    font-size: .95em;
    height: 1.6em;
    line-height: 1.6em;
    margin: 3px 0;
    text-align: right;
}
.box-header a {
    padding: 1px 3px;
    margin: 0 5px;
    height: 1.6em;
    line-height: 1.6em;
}
.box-header a:hover {
    text-decoration: underline;
}
.box-body {
    width: 100%;
}
.box-body-item {
    padding: 5px 0 5px 0;
    display: flex;
    flex-direction: column;
    border-bottom: 1px dotted #cccccc;
}
/* for left - right items */
.box-body-item-left {
    width: 73%;
}
.box-body-item-right {
    width: 24%;
    display: flex;
    flex-direction: row;
}
.box-body-item-label {
    width: 54%;
    font-size: .9em;
    line-height: 1.8em;
}
.box-body-item-value {
    width: 45%;
}
.box-body-item select {
    width: calc(100% - 10px);
    font-size: 1em;
    padding: 2px 0;
}
/* the label values items */
.bbi-label {
    width: 100%;
    padding: 0 0 3px 0;
    font-size: .8em;
    color: #666666;
    /* just for using the question marks */
    justify-content: space-between;
}
.bbi-value {
    width: calc(100% - 10px);
    padding: 2px 0px 2px 10px;
    font-size: .9em;
    color: #000000;
}
.bbi-label-hint {
    color: #999999;
    cursor: help;
}
.bbi-label-hint:hover {
    color: #333333;
}
.box-body h5 {
    padding: 0;
    margin: 0;
    font-size: 1em;
    height: 1.6em;
    line-height: 1.6em;
    margin: 3px 0;
}
.box-p {
    width: 100%;
    padding: 0;
    margin: 0;
    font-size: .9em;
}
.box-p-fixlen {    
    white-space: nowrap;
    text-overflow:ellipsis;
    overflow: hidden;
}
.box-footer {
    width: 100%;
    min-height: 20px;
    padding: 5px 0 5px 0;
}
/* font sizes */
.txt-sm {
    font-size: 0.9em;
}
.txt-nm {
    font-size: 1em;
}
.txt-lg {
    font-size: 1.3em;
}
.txt-xl {
    font-size: 1.6em;
}
/* font bold */
.txt-fb {
    font-weight: bold;
}
.box-header h4 {
    margin: 2px 0;
}
.select-sm {
    width: 80px;
}
html, body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    overflow: hidden;
}
body {
    font-size: 12px;
    font-family: Arial, Helvetica, sans-serif;
}
a {
    color: #333333;
    text-decoration: none;
}
#wrapper {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
}
#start-screen {
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
#ss-msg {
    width: 100%;
    padding: 10px 0;
    text-align: center;
}

/* for this page */
#app {
    width: 100%;
    height: calc(100% - 42px);
}
#app_oclist {
    width: 320px;
    padding: 0 5px;
    height: calc(100% - 15px);
    /* height: 810px; */
    /* background-color: whitesmoke; */
}
#app_oclist_aespanel {
    width: 100%;
    height: 100%;
    overflow-x: hidden;
    overflow-y: auto;
}
#vw_ocplots_mainpanel {
    width: calc(100% - 320px);
    padding: 0 5px;
    height: 100%;
}
#vw_ocplots_plotpanel {
    height: 100%;
    overflow-y: hidden;
}
.oc-group {
    cursor: pointer;
    padding: 3px 0;
    text-align: left;
    /* text-transform: uppercase; */
    background-color: #f3f3f3;
    border-top: 1px solid #cccccc;
}
.oc-name {
    width:     200px;
    min-width: 200px;
    cursor: pointer;
    padding: 2px 0;
}
.oc-type {
    width: 30px;
    min-width: 30px;
    text-align: center;
    cursor: pointer;
    padding: 2px 0;
}
.oc-type:hover {
    background-color: #cccccc;
    font-weight: bold;
}
.oc-type-selected {
    background-color: #555555;
    color: #ffffff;
    font-weight: bold;
}
.oc-cate {
    flex-direction: column;
}
.oc-cate-info {
    width: 100%;
    /* border-top: 1px solid #dddddd; */
    padding: 2px 0;
    border-bottom: 1px solid transparent;
}
.oc-cate-info:hover {
    border-bottom: 1px solid #555555;
}
.oc-cate-info .oc-name {
    font-weight: bold;
}
.oc-cate-info .oc-type {
    font-weight: bold;
}
.oc-items {
    width: 100%;
    padding-left: 20px;
}
.oc-items-hide {
    display: none;
}
.oc-item {
    width: 100%;
    border-left: 1px solid #aaaaaa;
}
.oc-item-info {
    width: calc(100% - 20px);
    border-bottom: 1px solid transparent;
}
.oc-item-info:hover {
    background-color: #efefef;
    border-bottom: 1px solid #cccccc;
}
.oc-item-info .oc-name {
    width:       170px;
    min-width:   170px;
    padding-left: 10px;
}
.oc-plot-img {
    width: 100%;
}
.oc-plot-tab {
    padding: 4px 15px;
    border: 0;
    color: #999999;
    border-bottom: 1px solid #999999;
    cursor: pointer;
}
.oc-plot-tab:hover {
    color: #555555;
    border-bottom: 1px solid #555555;
}
.oc-plot-tab-selected {
    color: #000000;
    font-weight: bold;
    border-bottom: 1px solid #000000;
}
.oc-plot-tab-page {
    display: none;
    padding: 10px 10px 0 15px;
    overflow-y: auto;
}
.oc-plot-tab-page-selected {
    display: block;
    overflow-y: auto;
}

.sfilter {
    margin-right: 15px;
}
.sfilter-name {
    font-size: 1.1em;
    padding: 2px 0;
}
.sfilter-select {
    width: 100%;
}
#app_filter {
    padding: 5px 0 0 5px;
}
#fig_scatter {
    width: 500px; 
    height: 500px;
}
#fig_sunburst {
    width: 600px; 
    height: 600px;
}
.fig-tooltip-header {
    border-bottom: 1px solid rgba(255,255,255,.3); 
    font-size: 1.2em;
    padding-bottom: 7px;
    margin-bottom: 7px;
}
.d-flex {
    display: flex;
}
.flex-row {
    flex-direction: row;
}
.flex-wrap {
    flex-wrap: wrap;
}
.flex-col {
    flex-direction: column;
}
.flex-align-items-baseline {
    align-items: baseline;
}
.flex-align-items-center {
    align-items: center;
}
#plot_nav {
    /* margin-top: -15px; */
    display: flex;
    flex-direction: row;
}
.plot-nav {
    padding: 3px 10px;
    color: #777777;
    border-bottom: 1px solid #333;
}
.plot-nav-active {
    border: 1px solid #333;
    color: #000000 !important;
    border-bottom: 0 !important;
    font-weight: bold;
}
#plot_main {
    padding: 5px;
    /* border-bottom: 1px solid #dfdfdf; */
}
#fig_sunburst {

}
#fig_sunburst_legend {
    position: relative;
    z-index: 10;
}
#fig_sunburst_legend img {
    position: absolute;
    top: 5px;
    left: 5px;
    width: 160px;
}
.fig-legend {
    opacity: 0.5;
}
.fig-legend:hover {
    opacity: 1;
}

.fh-g {

}
.fh-g-name {

}
.fh-c {
    padding: 2px;
    margin: 2px;
    /* border-right: 1px dotted #efefef; */
    /* border-bottom: 1px dotted #efefef; */
    border: 1px dotted #efefef;
}
.fh-c-5 {
    width: 90px;
}
.fh-c-8 {
    width: 145px;
}
.fh-c-10 {
    width: 190px;
}
.fh-c:hover {
    border-color: #777777;
}
.fh-c-name {
    font-size: 0.85em;
    padding: 1px 0;
    margin: 0 0 2px 0;
}
.fh-o {
    width: 10px;
    height: 10px;
    padding: 2px;
    margin: 1px;
    white-space: nowrap;
    text-overflow: clip;
    overflow: hidden;
    font-size: 0.7em;
    color: #999999;
    border: 1px solid #efefef;
}
.fh-o:hover {
    border-color: #777777;
}
#app_comptb {
    min-height: 800px;
    height: 99%;
    min-width: 1000px;
    padding: 0 5px;
}
.cmp-tb {

}
.cmp-tb-row {
    display: flex;
    flex-direction: row;
}
.cmp-tb-row:hover{
    background-color: whitesmoke;
}
.cmp-tb-row-header {
    position: sticky;
    top: 0;
    background-color: white;
    z-index: 99;
}
.cmp-tb-cell {
    width: 50px;
    min-width: 50px;

    height: 24px;
    min-height: 24px;
    display: flex;
    justify-content: center;
    /* align-self: center;    <---- REMOVE */
    align-items: center;   /* <---- NEW    */
    padding: 3px 0;
    border-bottom: 1px solid #dfdfdf;
}
.cmp-tb-cell-header {
    font-weight: bold;
    border-bottom: 1px solid #777777;
    padding: 4px 0;
}
.cmp-tb-cell-header-sortable {
    cursor: pointer;
}
.cmp-tb-cell-footer {
    font-weight: bold;
    /* border-top: 1px solid #777777; */
    padding: 4px 0;
}
.cmp-tb-cell-xs {
    width: 20px !important;
    min-width: 20px !important;
}
.cmp-tb-cell-sm {
    width: 50px !important;
    min-width: 50px !important;
}
.cmp-tb-cell-ocname {
    width: 160px !important;
    min-width: 160px !important;
}
.cmp-tb-cell-ocname-item {
    cursor: pointer;
}
.cmp-tb-cell-smtxt {
    font-size: 0.95em;
    list-style: 0.8em;
}
.cmp-tb-cell-sep {
    width: 45px !important;
    min-width: 45px !important;
}
.cmp-tb-cell-category {
    width: 120px !important;
    min-width: 120px !important;
}
.cmp-tb-cell-treatment {
    width: 140px !important;
    min-width: 140px !important;
}
.cmp-tb-cell-effect-lg {
    min-width: 360px !important;
    width: 360px !important;
    /* display: block !important; */
    position: relative;
    text-align: center;
}
.cmp-tb-cell-effect {
    min-width: 120px !important;
    width: 120px !important;
    /* display: block !important; */
    position: relative;
    text-align: center;
}
.cmp-tb-cell-eft {
    display: block !important;
    text-align: center;
}
.cmp-filters {
    width: 100%;
    font-style: italic;
    font-size: .85em;
}
.cmp-occate {
    width: 100%;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}
.cmp-ocname {
    width: 100%;
    white-space: nowrap;
    text-overflow: clip;
    overflow: hidden;
}
.cmp-eft-ci-line {
    height: 1px;
    position: absolute;
    top: 14px;
    border-bottom: 1px solid #333333;
}
.cmp-eft-dot {
    width: 7px;
    height: 7px;
    top: 12px;
    position: absolute;
    /* opacity: 0.8; */
}
.cmp-eft-value {
    font-size: .8em;
    color: #555555;
    margin-top: 0.5em;
    /* margin-left: 1em; */
    /* position: absolute; */
    /* left: 0; */
    width: 88px;
}
.cmp-tb-cell-effect .cmp-ref-one {
    position: absolute;
    left: 59px;
    top: 0;
    height: 100%;
    border-right: 1px dotted #aaaaaa;
}
.cmp-tb-cell-effect-lg .cmp-ref-one {
    position: absolute;
    left: 179px;
    top: 0;
    height: 100%;
    border-right: 1px dotted #aaaaaa;
}

.cmp-ref-50 {
    position: absolute;
    left: 60px;
    top: 0;
    height: 100%;
    border-right: 1px dotted #aaaaaa;
}

.btn {
    padding: 3px 5px;
    text-decoration: none !important;
}
.btn:hover {
    background-color: #cacaca;
}
.btn-remove {
    color: #ffdcdc;
}
.btn-remove:hover {
    color: white;
    background-color: rgb(255, 70, 70);
}
.btn-add-ocs {
    color: #888888;
}
.btn-add-ocs:hover {
    color: #333333;
    background-color: #cccccc;
}
#app_sclist {
    width: 600px;
}
.sc-item-panel {
    margin-top: 5px;
    height: 150px;
    overflow-x: hidden;
    overflow-y: auto;
}
.sc-item-box {
    position: relative;
}
.sc-item {
    margin: 5px 5px 0 0;
    padding: 1px;
    height: 130px;
    border-bottom: 1px solid #efefef;
}
.sc-item:hover {
    cursor: pointer;
    background-color: whitesmoke;
}
.sc-img {
    height: 110px;
}
.sc-close {
    position: absolute;
    top: 0;
    right: 0;
}
.sc-info {
    width: 100%;
    text-align: center;
    font-size: .8em;
    font-style: italic;
    white-space: nowrap;
    text-overflow: clip;
    overflow: hidden;
}
.forest-plot-panel {
    height: 100%;
    overflow-y: auto;
}
.hide {
    display: none;
}
.badge {
    padding: 1px 4px;
    background-color: #eeeeee;
    border-radius: 4px;
}
.badge-t, 
.badge-treatment {
    background-color: #EBF8FF;
}
.badge-i,
.badge-immune {
    background-color: #F4EBFF;
}

.ml-1 {
    margin-left: 1em;
}
.ml-2 {
    margin-left: 2em;
}
.ml-3 {
    margin-left: 3em;
}
.mr-1 {
    margin-right: 1em;
}
.mr-2 {
    margin-right: 2em;
}
.mr-3 {
    margin-right: 3em;
}
</style>
</head>
<body>
<div id="start-screen">
    <h1>
        <i class="fa fa-chart-bar"></i>
        Real-time Visual Analysis of Pairwise Meta-Analysis Results
    </h1>
    <div id="ss-msg">Loading data and initializing ...</div>
</div>

<div id="wrapper">

<div id="app_filter" class="d-flex flex-row">

    <div v-for="dropdown, dpd_idx in dropdowns"
        class="sfilter d-flex fx-col mr-3">
        <div class="sfilter-name">
            {{ dropdown.display_name }}
        </div>
        <div>
            <select class="sfilter-select"
                v-bind:value="dropdown.value"
                v-bind:disabled="is_filter_disabled(dpd_idx)"
                v-on:change="on_filter_value_change($event, dpd_idx)">
                <option v-for="opt in dropdown.options" 
                    v-bind:value="opt.value">
                    {{ opt.name }}
                </option>
            </select>
        </div>
    </div>

    <div class="d-flex fx-col mr-3">
        <div class="sfilter-name">
            Number of studies
        </div>
        <div style="height: 20px; line-height: 20px;">
            {{ n_papers }}
        </div>
    </div>
</div>

<div id="app" class="d-flex flex-row">

    <div id="app_oclist">
        <div class="box" style="height: 100%;">
            <div class="box-header">
                <h4>
                    <i class="fa fa-search"></i>
                    Outcome List | 
                </h4>
                <!-- <div>
                    <input type="text" class="box-input" style="background-color: transparent;">
                </div> -->
                <div class="d-flex flex-align-items-center">
                    <!-- <a class="btn" 
                        href="javascript:void(0);"
                        v-on:click="toggle_all_cates(false)">
                        <i class="fa fa-expand-alt"></i>
                        Expand
                    </a>
                    <a class="btn" 
                        href="javascript:void(0);"
                        v-on:click="toggle_all_cates(true)">
                        <i class="fa fa-compress-alt"></i>
                        Collapse
                    </a> -->
                    <select v-model="color_mode_by_sm"
                        class="select-sm">
                        <option value="RR">RR: Color by Risk Ratio</option>
                        <option value="OR">OR: Color by Odds Ratio</option>
                    </select>

                    <select v-model="cnt_rule"
                        class="select-sm">

                        <optgroup label="Simple Threshold">
                            <option value="ge1">All outcomes with at lease 1 study</option>
                            <option value="ge5">Equal or greater than 5 studies</option>
                            <option value="ge10">Equal or greater than 10 studies</option>
                            <option value="ge20">Equal or greater than 20 studies</option>
                        </optgroup>

                        <optgroup label="Complex Rules">
                            <option value="ge1s5">At lease 1 study but less than 5</option>
                            <option value="ge5ls10">Equal or greater than 5 but less than 10</option>
                            <option value="ge10ls20">Equal or greater than 10 but less than 20</option>
                        </optgroup>
                    </select>

                    <div id="show_overview" style="display: none;">
                        <a href="javascript:void(0);" 
                            title="Show Overview"
                            onclick="jarvis.set_mode(0)"
                            class="btn">
                            <i class="fas fa-plus-circle"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="box-body" style="height: calc(100% - 70px);">
                
                <div class="d-flex fx-col">
                    <div class="d-flex flex-row ">
                        <div class="oc-name" style="font-weight: bold;">
                            <div class="d-flex flex-row flex-align-items-baseline">
                                <span>
                                    Search: 
                                </span>
                                <input type="text" v-model="keyword"
                                    style="width: 80px;">
                                <a v-on:click="keyword = ''"
                                    class="btn btn-remove"
                                    style="margin: 3px 0 0 -24px;"
                                    href="javascript:void(0);">
                                    <i class="fa fa-times"></i>
                                </a>
                            </div>
                        </div>
                        <div style="font-weight: bold; width: 90px; text-align: center; border-bottom: 1px solid #555555;">
                            Grade
                        </div>
                    </div>
                </div>
    
                <div class="oc-cate d-flex fx-col">
                    <div class="oc-cate-info d-flex flex-row">
                        <div class="oc-name" style="font-weight: bold;">
                            {{ n_all() }}
                            Outcomes
                        </div>
                        <div class="oc-type" title="All Grades">
                            ALL
                        </div>
                        <div class="oc-type" title="Grade 3 or Higher">
                            3+
                        </div>
                        <div class="oc-type" title="Grade 5 Only">
                            5
                        </div>
                    </div>
                </div>
    
                <div id="app_oclist_aespanel">
                    <div class="oc-cate d-flex fx-col"
                        v-for="group in rs">
                        <div class="oc-group d-flex flex-row">
                            <div class="oc-name" 
                                v-on:click="toggle_group(group.oc_group)">
                                <i class="far fa-folder" v-if="group.is_close"></i>
                                <i class="far fa-folder-open" v-else></i>
                                {{ group.oc_group }} related AEs
                                ({{ n_group(group) }})
                            </div>
                            <div v-on:click="add_group(group, 'GA')"
                                class="oc-type">
                                <a :title="'Add [' + group.oc_group + '] GA outcomes'"
                                    class="btn-add-ocs"
                                    href="javascript:void(0);">
                                    <i class="fa fa-plus"></i>
                                </a>
                            </div>
                            <div v-on:click="add_group(group, 'G3H')"
                                class="oc-type">
                                <a :title="'Add [' + group.oc_group + '] G3+ outcomes'"
                                    class="btn-add-ocs"
                                    href="javascript:void(0);">
                                    <i class="fa fa-plus"></i>
                                </a>
                            </div>
                            <div v-on:click="add_group(group, 'G5N')"
                                class="oc-type">
                                <a :title="'Add [' + group.oc_group + '] G5 outcomes'"
                                    class="btn-add-ocs"
                                    href="javascript:void(0);">
                                    <i class="fa fa-plus"></i>
                                </a>
                            </div>
                        </div>
                        <div v-for="r in group.cates"
                            v-bind:class="{hide: group.is_close}"
                            v-show="match_keyword_in_cate(r)">
                            <div class="oc-cate-info d-flex flex-row">
                                <div v-on:click="toggle_cate(group.oc_group, r.oc_cate)"
                                    class="oc-name">
                                    <i class="far fa-folder" v-if="r.is_close"></i>
                                    <i class="far fa-folder-open" v-else></i>
                                    
                                    <span class="badge"
                                        :class="'badge-' + group.oc_group">
                                        {{ group.oc_group[0] }}
                                    </span>
                                    {{ r.oc_cate }}
                                    ({{ n_cate(r) }})
                                </div>
                                <div v-on:click="add_cate(r, 'GA')"
                                    class="oc-type">
                                    <a :title="'Add [' + r.oc_cate + '] GA outcomes'"
                                        class="btn-add-ocs"
                                        href="javascript:void(0);">
                                        <i class="fa fa-plus"></i>
                                    </a>
                                </div>
                                <div v-on:click="add_cate(r, 'G3H')"
                                    class="oc-type">
                                    <a :title="'Add [' + r.oc_cate + '] G3+ outcomes'"
                                        class="btn-add-ocs"
                                        href="javascript:void(0);">
                                        <i class="fa fa-plus"></i>
                                    </a>
                                </div>
                                <div v-on:click="add_cate(r, 'G5N')"
                                    class="oc-type">
                                    <a :title="'Add [' + r.oc_cate + '] G5 outcomes'"
                                        class="btn-add-ocs"
                                        href="javascript:void(0);">
                                        <i class="fa fa-plus"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="oc-items d-flex fx-col"
                                v-bind:class="{hide: r.is_close}">
                                <div class="oc-item"
                                    v-for="ae in r.aes">
                                    <div class="oc-item-info d-flex flex-row"
                                        v-show="show_oc(ae) && match_keyword(ae.oc_name)">
                                        <div class="oc-name">
                                            <i class="far fa-clipboard"></i>
                                            {{ ae.oc_name }}
                                        </div>

                                        
                                        <div class="oc-type"
                                            v-if="show_oc_grade(ae, 'GA')"
                                            v-bind:style="{ backgroundColor: get_eft_color(ma_dict[ae.oc_abbr].GA.PRIM.rsts[color_mode_by_sm]) }"
                                            v-on:click="add_oc(ae, 'GA')">
                                            {{ ae.cnt_ga }}
                                        </div>
                                        <div class="oc-type"
                                            v-else
                                            title="Not enough records">
                                            &nbsp;
                                        </div>


                                        <div class="oc-type"
                                            v-if="show_oc_grade(ae, 'G3H')"
                                            v-bind:style="{ backgroundColor: get_eft_color(ma_dict[ae.oc_abbr].G3H.PRIM.rsts[color_mode_by_sm]) }"
                                            v-on:click="add_oc(ae, 'G3H')">
                                            {{ ae.cnt_g3h }}
                                        </div>
                                        <div class="oc-type"
                                            v-else
                                            title="Not enough records">
                                            &nbsp;
                                        </div>


                                        <div class="oc-type"
                                            v-if="show_oc_grade(ae, 'G5N')"
                                            v-bind:style="{ backgroundColor: get_eft_color(ma_dict[ae.oc_abbr].G5N.PRIM.rsts[color_mode_by_sm]) }"
                                            v-on:click="add_oc(ae, 'G5N')">
                                            {{ ae.cnt_g5n }}
                                        </div>
                                        <div class="oc-type"
                                            v-else
                                            title="Not enough records">
                                            &nbsp;
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
    
                </div>
                
            </div>
    
            <div class="box-footer">
    
            </div>
        </div>
    </div>

    <div id="vw_ocplot">
        <div class="box" style="height: 100%;">
            <div class="box-header">
                <h4>
                    <i class="fa fa-chart-bar"></i>
                    Overview 
                </h4>
                <div class="d-flex flex-row flex-align-items-center">
                    <div style="margin-right: 2em;">
                        <a href="javascript:void(0);" 
                            onclick="jarvis.set_mode(4)"
                            class="btn">
                            <i class="far fa-minus-square"></i>
                            Hide
                        </a>
                    </div>
                </div>
            </div>

            <div class="box-body" style="height: 100%;">
                <div id="plot_nav">
                    <div class="plot-nav plot-nav-active">
                        <i class="fas fa-chart-pie"></i>
                        Sunburst
                    </div>

                </div>
                <div id="plot_main">
                    <div id="fig_sunburst_legend"
                        class="fig-legend">
                        <img src="./static/img/sunburst-legend.png" alt="">
                    </div>
                    <div id="fig_sunburst">
                    
                    </div>
    
                    <div id="fig_scatter"
                        style="display: none;">
    
                    </div>
    
                    <div id="fig_heatmap"
                        style="display: none;"
                        class="d-flex fx-column">
                        <div v-for="group, group_name in oc_dict3"
                            class="fh-g">
                            <div class="fh-g-name">
                                {{ group_name }}
                            </div>
                            <div class="fh-g-box d-flex flex-row flex-wrap">
                                <div v-for="cate, cate_name in group"
                                    v-bind:class="get_fh_c_cls(cate)"
                                    class="fh-c">
                                    <div class="fh-c-name">
                                        {{ cate_name }}
                                    </div>
                                    <div class="fh-c-box d-flex flex-row flex-wrap">
                                        <div v-for="oc, oc_abbr in cate"
                                            v-bind:title="oc.oc_name"
                                            class="fh-o">
                                            {{ get_oc_short_name(oc.oc_name) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div id="app_sclist"
                    class="d-flex flex-col">
                    <div class="box-header d-flex flex-row"
                        style="padding: 2px 0 3px 0;">
                        
                        <h4>
                            <i class="fas fa-book"></i>
                            Scenarios |
                        </h4>
                        <div class="d-flex flex-align-items-center">
                            <a v-on:click="add"
                                class="btn"
                                href="javascript:void(0);">
                                <i class="fa fa-plus"></i>
                                Add Above Scenario
                            </a>
                            <a v-on:click="rm_all"
                                class="btn btn-remove"
                                href="javascript:void(0);">
                                <i class="fa fa-minus"></i>
                            </a>
                            
                        </div>
                    </div>
                    <div class="d-flex flex-row flex-wrap sc-item-panel">
                        <div v-for="sc, sc_idx in scs"
                            v-on:click="load(sc)"
                            class="sc-item">
                            <div class="sc-item-box">
                                <img :src="sc.img_src" 
                                    alt=""
                                    class="sc-img">
                                <div class="sc-close">
                                    <a v-on:click="rm(sc_idx)"
                                        class="btn btn-remove" 
                                        href="javascript:void(0);">
                                        <i class="fa fa-minus"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="sc-info">
                                {{ sc.filter_vals[0] }}:
                                {{ sc.filter_vals[1] }} - 
                                {{ sc.filter_vals[4] }} 
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <div id="app_comptb">
        <div id="app_comptb_box" class="box" style="height: calc(50% - 20px);">
            <div class="box-header">
                <h4>
                    <i class="fas fa-table"></i>
                    Comparison 
                    <span v-if="f_ocs.length > 0"
                        style="padding: 0 3px; font-weight: normal;">
                        {{ f_ocs.length }} outcomes
                    </span>
                    |
                </h4>
                <div class="d-flex flex-row flex-align-items-baseline">
                    <div class="ml-1 mr-1">
                        <!-- <input type="radio"
                            id="input_show_effect_model_random"
                            value="random"
                            v-model="show_effect_model">
                        <label for="input_show_effect_model_random">Random Effect Model</label> 
                    
                        <input type="radio"
                            id="input_show_effect_model_fixed"
                            value="fixed"
                            v-model="show_effect_model">
                        <label for="input_show_effect_model_fixed">
                            Fixed Effect Model
                        </label>  -->
                        Model:
                        <select v-model="show_effect_model">
                            <option value="random">Random Effect Model</option>
                            <option value="Fixed">Fixed Effect Model</option>
                        </select>
                    </div>

                    <div style="margin-right: 2em;">
                        Measure: 
                        <select v-model="show_measure">
                            <option value="all">OR, RR, Incidence</option>
                            <option value="one">Single Measure</option>
                        </select>

                        <span v-if="show_measure == 'one'">
                            Measure of effect: 
                            <select v-model="measure_of_effect">
                                <option value="OR">Odds Ratio (OR)</option>
                                <option value="RR">Risk Ratio (RR)</option>
                                <option value="INCD">Incidence</option>
                            </select>
                        </span>
                    </div>
                    
                    <div style="margin-right: 2em;">
                        <input type="checkbox"
                            id="input_show_effect_label"
                            v-model="show_effect_label">
                        <label for="input_show_effect_label">Effect Size Label</label> 

                    </div>

                    <div style="margin-right: 2em;">
                        <a href="javascript:void(0);" 
                            v-on:click="rm_all_f_ocs"
                            class="btn">
                            <i class="far fa-trash-alt"></i>
                            Remove All
                        </a>
                    </div>
                    
                    <div style="margin-right: 2em;">
                        <a href="javascript:void(0);" 
                            onclick="jarvis.set_mode(1)"
                            class="btn">
                            <i class="fas fa-th-large"></i>
                            Half Half
                        </a>
                        <a href="javascript:void(0);" 
                            onclick="jarvis.set_mode(2)"
                            class="btn">
                            <i class="fas fa-expand"></i>
                            Maximum
                        </a>
                    </div>
                    

                </div>
            </div>

            <div v-if="f_ocs.length == 0"
                class="box-body" style="height: 100%; overflow-y: auto;">
                
                
            </div>
            <div v-else
                class="box-body" style="height: 100%; overflow-y: auto; overflow-x: hidden;">
                <div class="cmp-tb">
                    <div class="cmp-tb-row cmp-tb-row-header">
                        <div v-on:click=""
                            class="cmp-tb-cell cmp-tb-cell-xs cmp-tb-cell-header">
                            G
                        </div>

                        <div v-on:click=""
                            class="cmp-tb-cell cmp-tb-cell-category cmp-tb-cell-header">
                            Category
                        </div>

                        <div v-on:click="toggle_sort_by('default')"
                            class="cmp-tb-cell cmp-tb-cell-ocname cmp-tb-cell-header cmp-tb-cell-header-sortable">
                            Outcome
                        </div>

                        <div v-on:click=""
                            class="cmp-tb-cell cmp-tb-cell-header">
                            Grade
                        </div>


                        <div v-on:click=""
                            class="cmp-tb-cell cmp-tb-cell-treatment cmp-tb-cell-header">
                            Treatment
                        </div>

                        <div v-on:click=""
                            class="cmp-tb-cell cmp-tb-cell-header">
                            Control
                        </div>

                        <div v-on:click=""
                            class="cmp-tb-cell cmp-tb-cell-header">
                            Cancer
                        </div>


                        <div v-on:click="toggle_sort_by('NS')"
                            class="cmp-tb-cell cmp-tb-cell-sm cmp-tb-cell-header cmp-tb-cell-header-sortable">
                            Studies
                            <br>
                            <i v-if="sort_ocs_by == 'NS_desc'"
                                class="fas fa-sort-numeric-down-alt"></i>
                            <i v-else-if="sort_ocs_by == 'NS_asc'"
                                class="fas fa-sort-numeric-down"></i>
                        </div>


                        <div v-on:click="toggle_sort_by('NPEt')"
                            class="cmp-tb-cell cmp-tb-cell-header cmp-tb-cell-header-sortable">
                            Et
                            <i v-if="sort_ocs_by == 'NPEt_desc'"
                                class="fas fa-sort-numeric-down-alt"></i>
                            <i v-else-if="sort_ocs_by == 'NPEt_asc'"
                                class="fas fa-sort-numeric-down"></i>
                        </div>
                        <div v-on:click="toggle_sort_by('NPNt')"
                            class="cmp-tb-cell cmp-tb-cell-header cmp-tb-cell-header-sortable">
                            Nt
                            <i v-if="sort_ocs_by == 'NPNt_desc'"
                                class="fas fa-sort-numeric-down-alt"></i>
                            <i v-else-if="sort_ocs_by == 'NPNt_asc'"
                                class="fas fa-sort-numeric-down"></i>
                        </div>
                        <div v-on:click="toggle_sort_by('NPEc')"
                            class="cmp-tb-cell cmp-tb-cell-header cmp-tb-cell-header-sortable">
                            Ec
                            <i v-if="sort_ocs_by == 'NPEc_desc'"
                                class="fas fa-sort-numeric-down-alt"></i>
                            <i v-else-if="sort_ocs_by == 'NPEc_asc'"
                                class="fas fa-sort-numeric-down"></i>
                        </div>
                        <div v-on:click="toggle_sort_by('NPNc')"
                            class="cmp-tb-cell cmp-tb-cell-header cmp-tb-cell-header-sortable">
                            Nc
                            <i v-if="sort_ocs_by == 'NPNc_desc'"
                                class="fas fa-sort-numeric-down-alt"></i>
                            <i v-else-if="sort_ocs_by == 'NPNc_asc'"
                                class="fas fa-sort-numeric-down"></i>
                        </div>

                        <div v-if="show_measure == 'all' || measure_of_effect == 'OR'"
                            v-on:click="toggle_sort_by('OR')"
                            :class="{'cmp-tb-cell-effect': show_measure == 'all', 'cmp-tb-cell-effect-lg': show_measure == 'one'}"
                            class="cmp-tb-cell cmp-tb-cell-header                            cmp-tb-cell-header-sortable">
                            Odds Ratio
                            &nbsp;
                            <i v-if="sort_ocs_by == 'OR_desc'"
                                class="fas fa-sort-numeric-down-alt"></i>
                            <i v-else-if="sort_ocs_by == 'OR_asc'"
                                class="fas fa-sort-numeric-down"></i>
                        </div>
                        <div v-if="show_measure == 'all' || measure_of_effect == 'OR'"
                            class="cmp-tb-cell cmp-tb-cell-sep cmp-tb-cell-header">
                            &nbsp;
                        </div>

                        <div v-if="show_measure == 'all' || measure_of_effect == 'RR'"
                            v-on:click="toggle_sort_by('RR')"
                            :class="{'cmp-tb-cell-effect': show_measure == 'all', 'cmp-tb-cell-effect-lg': show_measure == 'one'}"
                            class="cmp-tb-cell cmp-tb-cell-header cmp-tb-cell-header-sortable">
                            Risk Ratio
                            &nbsp;
                            <i v-if="sort_ocs_by == 'RR_desc'"
                                class="fas fa-sort-numeric-down-alt"></i>
                            <i v-else-if="sort_ocs_by == 'RR_asc'"
                                class="fas fa-sort-numeric-down"></i>
                        </div>
                        <div v-if="show_measure == 'all' || measure_of_effect == 'RR'"
                            class="cmp-tb-cell cmp-tb-cell-sep cmp-tb-cell-header">
                            &nbsp;
                        </div>

                        <div v-if="show_measure == 'all' || measure_of_effect == 'INCD'"
                            v-on:click="toggle_sort_by('INCD')" 
                            :class="{'cmp-tb-cell-effect': show_measure == 'all', 'cmp-tb-cell-effect-lg': show_measure == 'one'}"
                            class="cmp-tb-cell cmp-tb-cell-header cmp-tb-cell-header-sortable">
                            Incidence %
                            &nbsp;
                            <i v-if="sort_ocs_by == 'INCD_desc'"
                                class="fas fa-sort-numeric-down-alt"></i>
                            <i v-else-if="sort_ocs_by == 'INCD_asc'"
                                class="fas fa-sort-numeric-down"></i>
                        </div>

                        <div class="cmp-tb-cell cmp-tb-cell-header">
                            
                            <a v-on:click="rm_all_f_ocs"
                                href="javascript:void(0);"
                                class="btn btn-remove">
                                <i class="fa fa-minus"></i>
                            </a>
                        </div>
                    </div>

                    <div v-for="v in v_sort_ocs(f_ocs)"
                        class="cmp-tb-row">
                        <div class="cmp-tb-cell cmp-tb-cell-xs">
                            <span class="badge"
                                :title="f_ocs[v.idx].oc_group + ' related AE'"
                                :class="'badge-' + f_ocs[v.idx].oc_group">
                                {{ f_ocs[v.idx].oc_group[0] }}
                            </span>
                        </div>

                        <div class="cmp-tb-cell cmp-tb-cell-category cmp-tb-cell-smtxt">
                            <div class="cmp-occate">
                                {{ f_ocs[v.idx].oc_cate }}
                            </div>
                        </div>

                        <div v-on:click="show_detail(f_ocs[v.idx])"
                            class="cmp-tb-cell cmp-tb-cell-ocname cmp-tb-cell-ocname-item flex-col">
                            <div class="cmp-ocname">
                                {{ f_ocs[v.idx].oc_name }}
                            </div>
                        </div>


                        <div class="cmp-tb-cell cmp-tb-cell-smtxt">
                            {{ _txt(f_ocs[v.idx].ae_grade, 'grade') }}
                        </div>


                        <div class="cmp-tb-cell cmp-tb-cell-treatment cmp-tb-cell-smtxt">
                            {{ _txt_treat(f_ocs[v.idx].f_vals) }}
                        </div>

                        <div class="cmp-tb-cell cmp-tb-cell-smtxt">
                            {{ _txt(f_ocs[v.idx].f_vals[4], 'filter') }}
                        </div>

                        <div class="cmp-tb-cell cmp-tb-cell-smtxt">
                            {{ _txt(f_ocs[v.idx].f_vals[5], 'filter') }}
                        </div>

                        
                        <div class="cmp-tb-cell cmp-tb-cell-sm">
                            {{ f_ocs[v.idx].ma.PRIM.stus.length }}
                        </div>
                        <div class="cmp-tb-cell">
                            {{ add_comma(f_ocs[v.idx].ma.PRIM.total[0]) }}
                        </div>
                        <div class="cmp-tb-cell">
                            {{ add_comma(f_ocs[v.idx].ma.PRIM.total[1]) }}
                        </div>
                        <div class="cmp-tb-cell">
                            {{ add_comma(f_ocs[v.idx].ma.PRIM.total[2]) }}
                        </div>
                        <div class="cmp-tb-cell">
                            {{ add_comma(f_ocs[v.idx].ma.PRIM.total[3]) }}
                        </div>

                        <div v-if="show_measure == 'all' || measure_of_effect == 'OR'"
                            :class="{'cmp-tb-cell-effect': show_measure == 'all', 'cmp-tb-cell-effect-lg': show_measure == 'one'}"
                            class="cmp-tb-cell">

                            <div class="cmp-eft-dot"
                                v-bind:style="{left: get_eft_left_by_rst(f_ocs[v.idx].ma.PRIM.rsts.OR) + 'px', backgroundColor: get_eft_color(f_ocs[v.idx].ma.PRIM.rsts.OR)}">

                                <div v-if="show_effect_label" 
                                    class="cmp-eft-value">
                                    {{ tf2(f_ocs[v.idx].ma.PRIM.rsts.OR[show_effect_model].SM ) }}
                                    ({{ tf2(f_ocs[v.idx].ma.PRIM.rsts.OR[show_effect_model].SM_lower ) }}; {{ tf2(f_ocs[v.idx].ma.PRIM.rsts.OR[show_effect_model].SM_upper ) }})
                                </div>
                            </div>

                            <div class="cmp-eft-ci-line"
                                v-bind:style="{width: get_ci_width_by_rst(f_ocs[v.idx].ma.PRIM.rsts.OR) + 'px', left: get_ci_left_by_rst(f_ocs[v.idx].ma.PRIM.rsts.OR) + 'px'}">
                            </div>

                            <div class="cmp-ref-one"></div>
                        </div>
                        <div v-if="show_measure == 'all' || measure_of_effect == 'OR'"
                            class="cmp-tb-cell cmp-tb-cell-sep">
                            &nbsp;
                        </div>
                        <!-- <div class="cmp-tb-cell cmp-tb-cell-eft">
                            OR={{ tf2(f_ocs[v.idx].ma.PRIM.rsts.OR.random.SM ) }}
                            <br>
                            {{ tf2(f_ocs[v.idx].ma.PRIM.rsts.OR.random.SM_lower ) }},
                            {{ tf2(f_ocs[v.idx].ma.PRIM.rsts.OR.random.SM_upper ) }}
                        </div> -->


                        <div v-if="show_measure == 'all' || measure_of_effect == 'RR'"
                            :class="{'cmp-tb-cell-effect': show_measure == 'all', 'cmp-tb-cell-effect-lg': show_measure == 'one'}"
                            class="cmp-tb-cell">

                            <div class="cmp-eft-dot"
                                v-bind:style="{left: get_eft_left_by_rst(f_ocs[v.idx].ma.PRIM.rsts.RR) + 'px', backgroundColor: get_eft_color(f_ocs[v.idx].ma.PRIM.rsts.RR)}">
                                <div v-if="show_effect_label" 
                                    class="cmp-eft-value">
                                    {{ tf2(f_ocs[v.idx].ma.PRIM.rsts.RR[show_effect_model].SM ) }}
                                    ({{ tf2(f_ocs[v.idx].ma.PRIM.rsts.RR[show_effect_model].SM_lower ) }}; {{ tf2(f_ocs[v.idx].ma.PRIM.rsts.RR[show_effect_model].SM_upper ) }})
                                </div>
                            </div>

                            <div class="cmp-eft-ci-line"
                                v-bind:style="{width: get_ci_width_by_rst(f_ocs[v.idx].ma.PRIM.rsts.RR) + 'px', left: get_ci_left_by_rst(f_ocs[v.idx].ma.PRIM.rsts.RR) + 'px'}">
                            </div>

                            <div class="cmp-ref-one"></div>
                        </div>
                        <div v-if="show_measure == 'all' || measure_of_effect == 'RR'"
                            class="cmp-tb-cell cmp-tb-cell-sep">
                            &nbsp;
                        </div>
                        <!-- <div class="cmp-tb-cell cmp-tb-cell-eft">
                            RR={{ tf2(f_ocs[v.idx].ma.PRIM.rsts.RR.random.SM ) }}
                            <br>
                            {{ tf2(f_ocs[v.idx].ma.PRIM.rsts.RR.random.SM_lower ) }},
                            {{ tf2(f_ocs[v.idx].ma.PRIM.rsts.RR.random.SM_upper ) }}
                        </div> -->


                        <div v-if="show_measure == 'all' || measure_of_effect == 'INCD'"
                            :class="{'cmp-tb-cell-effect': show_measure == 'all', 'cmp-tb-cell-effect-lg': show_measure == 'one'}"
                            class="cmp-tb-cell">

                            <div class="cmp-eft-dot"
                                v-bind:style="{left: get_eft_left_by_rst(f_ocs[v.idx].ma.INCD.rsts.INCD, 'linear') + 'px', backgroundColor: get_eft_color(f_ocs[v.idx].ma.INCD.rsts.INCD)}">
                                <div v-if="show_effect_label" 
                                    class="cmp-eft-value">
                                    {{ tf2(100*f_ocs[v.idx].ma.INCD.rsts.INCD[show_effect_model].SM ) }}
                                    ({{ tf2(100*f_ocs[v.idx].ma.INCD.rsts.INCD[show_effect_model].SM_lower ) }}; {{ tf2(100*f_ocs[v.idx].ma.INCD.rsts.INCD[show_effect_model].SM_upper ) }})
                                </div>
                            </div>

                            <div class="cmp-eft-ci-line"
                                v-bind:style="{width: get_ci_width_by_rst(f_ocs[v.idx].ma.INCD.rsts.INCD, 'linear') + 'px', left: get_ci_left_by_rst(f_ocs[v.idx].ma.INCD.rsts.INCD, 'linear') + 'px'}">
                            </div>

                            <!-- <div class="cmp-ref-50"></div> -->
                        </div>
                        <!-- <div class="cmp-tb-cell cmp-tb-cell-eft">
                            IN={{ tf2(f_ocs[v.idx].ma.INCD.rsts.INCD.random.SM ) }}
                            <br>
                            {{ tf2(f_ocs[v.idx].ma.INCD.rsts.INCD.random.SM_lower ) }},
                            {{ tf2(f_ocs[v.idx].ma.INCD.rsts.INCD.random.SM_upper ) }}
                        </div> -->

                        <div class="cmp-tb-cell">
                            <a v-on:click="rm_f_oc(v.idx)"
                                href="javascript:void(0);"
                                class="btn btn-remove">
                                <i class="fa fa-minus"></i>
                            </a>
                        </div>
                    </div>

                    <div class="cmp-tb-row">

                        <div class="cmp-tb-cell cmp-tb-cell-xs cmp-tb-cell-footer">
                            <!-- group -->
                        </div>
                        <div class="cmp-tb-cell cmp-tb-cell-category cmp-tb-cell-footer">
                            <!-- category -->
                        </div>
                        <div class="cmp-tb-cell cmp-tb-cell-ocname cmp-tb-cell-footer">
                            <!-- outcome name -->
                        </div>

                        

                        <div class="cmp-tb-cell cmp-tb-cell-footer">
                            <!-- grade -->
                        </div>

                        <div class="cmp-tb-cell cmp-tb-cell-treatment cmp-tb-cell-footer">
                            <!-- treatment -->
                        </div>

                        <div class="cmp-tb-cell cmp-tb-cell-footer">
                            <!-- control -->
                        </div>

                        <div class="cmp-tb-cell cmp-tb-cell-footer">
                            <!-- cancer -->
                        </div>
                        


                        <div class="cmp-tb-cell cmp-tb-cell-sm cmp-tb-cell-footer">
                            <!-- n_stus -->
                        </div>
                        <div class="cmp-tb-cell cmp-tb-cell-footer">
                            <!-- Et -->
                        </div>
                        <div class="cmp-tb-cell cmp-tb-cell-footer">
                            <!-- Nt -->
                        </div>
                        <div class="cmp-tb-cell cmp-tb-cell-footer">
                            <!-- Ec -->
                        </div>
                        <div class="cmp-tb-cell cmp-tb-cell-footer">
                            <!-- Nc -->
                        </div>

                        <div v-if="show_measure == 'all' || measure_of_effect == 'OR'"
                            :class="{'cmp-tb-cell-effect': show_measure == 'all', 'cmp-tb-cell-effect-lg': show_measure == 'one'}"
                            class="cmp-tb-cell cmp-tb-cell-footer">
                            <!-- x-axis for OR -->
                            <img style="width: 100%;" src="./static/img/log-axis.png">
                        </div>
                        <div class="cmp-tb-cell cmp-tb-cell-sep cmp-tb-cell-footer">
                            <!-- just for white space -->
                            &nbsp;
                        </div>

                        <div v-if="show_measure == 'all' || measure_of_effect == 'RR'"
                            :class="{'cmp-tb-cell-effect': show_measure == 'all', 'cmp-tb-cell-effect-lg': show_measure == 'one'}"
                            class="cmp-tb-cell cmp-tb-cell-footer">
                            <!-- x-axis for RR -->
                            <img style="width: 100%;" src="./static/img/log-axis.png">
                        </div>
                        <div class="cmp-tb-cell cmp-tb-cell-sep cmp-tb-cell-footer">
                            <!-- just for white space -->
                            &nbsp;
                        </div>

                        <div v-if="show_measure == 'all' || measure_of_effect == 'INCD'"
                            :class="{'cmp-tb-cell-effect': show_measure == 'all', 'cmp-tb-cell-effect-lg': show_measure == 'one'}"
                            class="cmp-tb-cell cmp-tb-cell-footer">
                            <!-- x-axis for INCD -->
                            <img style="width: 100%;" src="./static/img/x-axis-0-100.png">
                        </div>

                        <div class="cmp-tb-cell cmp-tb-cell-footer">
                            <!-- operations -->
                        </div>

                    </div>


                </div>
                
            </div>

        </div>

        <div id="app_detail_box" class="box" style="height: calc(50% - 20px);">
            <div class="box-header">
                <h4>
                    <i class="fa fa-chart-bar"></i>
                    Outcome Detail | 
                </h4>

                <div class="d-flex flex-align-items-center">
                    <a onclick="app_comptb.vpp.export_f_oc();"
                        class="btn"
                        style="margin-right: 2em;"
                        href="javascript:void(0);">
                        <i class="fas fa-file-export"></i>
                        Export CSV
                    </a>

                    <a onclick="fg_pwma_forest.hide();"
                        class="btn btn-remove"
                        href="javascript:void(0);">
                        <i class="fa fa-minus"></i>
                    </a>

                </div>
                
            </div>

            <div class="box-body" style="height: 100%;">
                <div class="plot-nav-tab d-flex flex-row">
                    <div class="plot-nav plot-nav-active">
                        <i class="fas fa-chart-line"></i>
                        Forest Plot
                    </div>
                </div>

                <div class="forest-plot-panel">
                    
                    <div id="fg_pwma_forest" style="width: 100%; height: 100%;">
                        <svg id="fg_pwma_forest_svg"></svg>
                    </div>

                    
                </div>
            </div>
            
        </div>
    </div>
</div>

</div>

<!-- use third party libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/0.5.5/alasql.min.js"></script>

<!-- D3.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.1/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>

<!-- load the scripts for meta analysis -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.1.1/math.min.js"></script>
<script src="https://ohnlp.github.io/Meta.js/dist/metajs-0.0.3.js"></script>

<!-- for data exploration -->
<script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.0/lib/bundle.js"></script>

<!-- for visualization -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.3.2/echarts.min.js"></script>

<!-- PapaParse for export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>

<!-- filesaver -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>


<script>
var isIE = /*@cc_on!@*/false || !!document.documentMode;
if (isIE) {
    document.getElementById('ss-msg').innerHTML = 'The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.';
}
</script>

<script>

var srv_pubmed = {
    ret: null,
    paper_dict: null,
    url: {
        esearch: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed',
        esummary: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed',
        efetch: "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed",
        view_pmid: 'https://www.ncbi.nlm.nih.gov/pubmed/?term=',
        show: 'https://pubmed.ncbi.nlm.nih.gov/'
    },

    show: function(pmid) {
        var url = this.url.show + pmid + '/';
        window.open(url, "_blank");
    },
    
    efetch: function(ids, callback) {
        $.get(
            this.url.efetch,
            {id: ids.join(','), retmode:'xml'},
            callback, 'xml'
        );
    },

    parse_efetch_data: function(data) {
        var xml = $(data);
        var docs = xml.find('PubmedArticle');
        
        var paper_dict = {};
        for (var i = 0; i < docs.length; i++) {
            var doc = $(docs[i]);

            // get PMID
            var pmid = doc.find('PMID')[0].textContent;

            // get title
            var title = doc.find('ArticleTitle')[0].textContent;
            title = title.trim();

            // get title
            var abstract = doc.find('Abstract')[0].textContent;
            abstract = abstract.trim();

            // get authors
            var authors = [];
            var authors_elems = doc.find('Author');
            for (var j = 0; j < authors_elems.length; j++) {
                var elem = $(authors_elems[j]);
                try {
                    var last_name = elem.find('LastName')[0].textContent;
                    var fore_name = elem.find('ForeName')[0].textContent;
                    var name = fore_name + ' ' + last_name;
                    authors.push(name);
                } catch (err) {
                    
                }
            }

            // get journal
            // var journal = doc.find('Journal Title')[0].textContent;
            var journal = doc.find('ISOAbbreviation')[0].textContent;

            // get date
            var pub_date = '';
            try {
                const y = doc.find('ArticleDate Year')[0].textContent;
                const m = doc.find('ArticleDate Month')[0].textContent;
                const d = doc.find('ArticleDate Day')[0].textContent;
                pub_date = y + '-' + m + '-' + d;
            } catch {
                try {
                    const y = doc.find('DateCompleted Year')[0].textContent;
                    const m = doc.find('DateCompleted Month')[0].textContent;
                    const d = doc.find('DateCompleted Day')[0].textContent;
                    pub_date = y + '-' + m + '-' + d;
                } catch {
                    try {
                        const y = doc.find('PubDate Year')[0].textContent;
                        const m = doc.find('PubDate Month')[0].textContent;
                        pub_date = y + '-' + m;
                    } catch {
                        pub_date = doc.find('Year')[0].textContent;
                    }
                }
            }
            pub_date = pub_date.trim();

            // update the record
            paper_dict[pmid] = {};
            paper_dict[pmid].pmid = pmid;
            paper_dict[pmid].title = title;
            paper_dict[pmid].abstract = abstract;
            paper_dict[pmid].authors = authors;
            paper_dict[pmid].journal = journal;
            paper_dict[pmid].pub_date = pub_date;

            // most important, bind this doc to paper
            paper_dict[pmid].xml = doc;
        }

        return paper_dict;
    },

    esummary: function(ids, callback) {
        $.get(
            this.url.esummary,
            {id: ids.join(',')},
            callback, 'xml'
        );
    },

    parse_esummary_data: function(data) {
        var xml = $(data);
        var docsums = xml.find('DocSum');
        
        var paper_dict = {};
        for (var i = 0; i < docsums.length; i++) {
            var docsum_xml = $(docsums[i]);

            // get PMID
            var pmid = docsum_xml.find('Id')[0].textContent;

            // get title
            var title = docsum_xml.find('Item[Name="Title"]')[0].textContent;

            // get authors
            var authors = [];
            var authors_elems = docsum_xml.find('Item[Name="Author"]');
            for (var j = 0; j < authors_elems.length; j++) {
                var elem = authors_elems[j];
                authors.push(elem.textContent);
            }

            // get journal
            var journal = docsum_xml.find('Item[Name="FullJournalName"]')[0].textContent;

            // get date
            var pub_date = docsum_xml.find('Item[Name="PubDate"]')[0].textContent;

            // update the record
            paper_dict[pmid] = {};
            paper_dict[pmid].title = title;
            paper_dict[pmid].journal = journal;
            paper_dict[pmid].pub_date = pub_date;
            paper_dict[pmid].authors = authors;
        }
        return paper_dict;
    }
};
var srv_rpltapi = {
    
    url: {
        pwma_prcm: "/rplt/PWMA_PRCM",
        pwma_incd: "/rplt/PWMA_INCD",
    },
    

    analyze_pwma_prcm: function(params, callback) {
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url: this.url.pwma_prcm,
            data: params,
            cache: false,
            success: callback,
            error: function(jqXHR, textStatus, errorThrown) {
                console.error(textStatus, errorThrown);
            }
        });
    },

    analyze_pwma_incd: function(params, callback) {
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url: this.url.pwma_prcm,
            data: params,
            cache: false,
            success: callback,
            error: function(jqXHR, textStatus, errorThrown) {
                console.error(textStatus, errorThrown);
            }
        });
    } 
};

///////////////////////////////////////////////////////////
// The plots for PWMA
///////////////////////////////////////////////////////////
var fgmk_pwma_forest = {

    make_fig: function(box_id) {
    
    return {
        box_id: '#'+box_id,
        plot_id: '#'+box_id+'_svg',
        plot_type: 'd3js',
        svg: null,
        cols: null,

        layout: {
            PRIM_CAT_RAW: [
                {width: 150, align: 'start',  name: 'Study', x: 0, row: 2},
                {width: 50,  align: 'end',    name: 'Events', row: 2},
                {width: 50,  align: 'end',    name: 'Total', row: 2},
                {width: 50,  align: 'end',    name: 'Events', row: 2},
                {width: 50,  align: 'end',    name: 'Total', row: 2},
        
                {width: 50,  align: 'end',    name: '$SM$', row: 2},
                {width: 100, align: 'end',    name: '95% CI', row: 2},
                {width: 200, align: 'middle', name: '$SM_NAME$ (95% CI)', row: 2},
                {width: 100, align: 'end',    name: 'Relative weight', row: 2}
            ],
            PRIM_CAT_PRE: [
                {width: 200, align: 'start',  name: 'Study', x: 0, row: 2},
                {width: 5,  align: 'end',    name: '', row: 2},
                {width: 5,  align: 'end',    name: '', row: 2},
                {width: 5,  align: 'end',    name: '', row: 2},
                {width: 5,  align: 'end',    name: '', row: 2},
        
                {width: 50,  align: 'end',    name: '$SM$', row: 2},
                {width: 100, align: 'end',    name: '95% CI', row: 2},
                {width: 250, align: 'middle', name: '$SM_NAME$ (95% CI)', row: 2},
                {width: 100, align: 'end',    name: 'Relative weight', row: 2}
            ],
        },

        row_height: 15,
        min_dot_size: 4,
        row_txtmb: 3,
        row_frstml: 20,
        default_height: 300,
        max_study_name_length: 30,
        
        is_draw_prediction_interval: false,
        loc: {
            prediction_interval: 5,
            heterogeneity: 5,
        },
    
        css: {
            txt_bd: 'prim-frst-txt-bd',
            txt_nm: 'prim-frst-txt-nm',
            txt_mt: 'prim-frst-txt-mt',
            txt_sm: 'prim-frst-txt-sm',
            txt_clickable: 'prim-frst-txt-clickable',
            stu_g: 'prim-frst-stu-g',
            stu_bg: 'prim-frst-stu-bg',
            stu_rect: 'prim-frst-stu-rect'
        },
        css_html: ["<style>",
            ".prim-frst-txt-bd{ font-weight: bold; }",
            ".prim-frst-txt-nm{ font-weight: normal; }",
            ".prim-frst-txt-mt{ font-family: Times; font-style: italic; }",
            ".prim-frst-txt-sm{ font-size: xx-small; }",
            ".prim-frst-stu-g text{ cursor: default; }",
            ".prim-frst-stu-bg{ fill: white; }",
            ".prim-frst-stu-rect{ fill: black; }",
            ".prim-frst-stu-line{ stroke: black; stroke-width: 1; }",
            ".prim-frst-stu-model{ fill: red; stroke: black; stroke-width: 1; }",
            ".prim-frst-stu-model-refline{ stroke: black; stroke-width: 1; }",
            ".prim-frst-stu-g:hover .prim-frst-stu-bg{ fill: whitesmoke; }",
            ".prim-frst-txt-clickable{ fill: #00397b; cursor: pointer !important; }",
            ".prim-frst-txt-clickable:hover{ fill: blue; }",
            "</style>"
        ].join('\n'),
    
        _x_scale: function(v) {
            var x = this.x_scale(v);
    
            if (x.toString() == 'NaN') {
                return 0;
            } else {
                if (x < 0) {
                    return 0;
                }
                return x;
            }
        },
    
        init: function() {
            // add CSS classes
            $(this.box_id).append(this.css_html);
    
            // set the width of this plot
            this.width = 0;

            if (this.cols != null) {
                for (var i = 0; i < this.cols.length; i++) {
                    var col = this.cols[i];
                    col.x = i>0? this.cols[i-1].x + this.cols[i-1].width : 0;
                    this.width += col.width;
                }
            }
            
            // set the default height this plot
            this.height = this.default_height;
    
            // init the svg
            this.svg = d3.select(this.plot_id)
                .attr('width', this.width)
                .attr('height', this.height);
        },
    
        /**
         * 
         * @param {Object} data A meta.js result
         * {
         *     stus: [{
         *         Et: , Nt: , Ec: , Nc: , study, year
         *         // add the following by other script
         *         SM, SM_lower, SM_upper,
         *     }],
         *     model: {
         *         // the typcial output the meta.js
         *         SM, TE, fixed, random, heterogeneity, ...
         *     }
         * }
         * @param {*} cfg config
         * {
         *     sm: {
         *         sm: 'OR' // other other
         *         name: 'Odds Ratio
         *     },
         *     mode: 'pwma_prcm',
         *     params: {
         *         input_format: 'PRIM_CAT_RAW',  // or PRIM_CAT_PRE
         *         fixed_or_random: 'random',     // or fixed
         *         prediction_interval: false,    // or true
         *     }
         * }
         */
        draw: function(data, cfg) {
            $(this.box_id).show();

            console.log('* draw pwma_forest_plot', data, cfg);

            // change some settings according to the raw data format
            if (cfg.params.hasOwnProperty('input_format')) {
                // set the format according the input format
                this.cols = this.layout[cfg.params.input_format];

            } else {
                // default is just using the raw
                this.cols = this.layout.PRIM_CAT_RAW;
            }
            
            // clear the old plot first
            this.clear();
    
            // bind new data
            this.data = data;
            this.cfg = cfg;
    
            // update the height of svg according to number of studies
            // 8 is the number of lines of header and footers
            this.height = this.row_height * (this.data.stus.length + 8);
            this.svg.attr('height', this.height);
            
            // if we draw the predict interval, add one more line
            if (this.cfg.params.prediction_interval == 'TRUE') {
                this.is_draw_prediction_interval = true;
                this.height += this.row_height;
            } else {
                this.is_draw_prediction_interval = false;
            }
    
            // show header
            this._draw_header();
            
            // show studies
            this._draw_study_vals();
    
            // show the prediction interval
            if (this.is_draw_prediction_interval) {
                this._draw_predition_interval();
            }
            
            // show the model text
            this._draw_heter();
    
            // show the plot
            this._draw_forest();
    
        },

        _is_input_format: function(fmt) {
            
            if (this.cfg.params.input_format == fmt) {
                return true;
            } else {
                return false;
            }
        },

        is_input_format_cat_raw: function() {
            return this._is_input_format('PRIM_CAT_RAW');
        },
    
        _draw_header: function() {
            if (this.is_input_format_cat_raw()) {
                this.svg.append('text')
                    .attr('class', this.css.txt_bd)
                    .attr('x', this.cols[3].x)
                    .attr('y', this.row_height)
                    .attr('text-anchor', "end")
                    .text('Treatment');
                
                this.svg.append('text')
                    .attr('class', this.css.txt_bd)
                    .attr('x', this.cols[5].x)
                    .attr('y', this.row_height)
                    .attr('text-anchor', "end")
                    .text('Control');
            } else {

            }
            
            for (var i = 0; i < this.cols.length; i++) {
                var col = this.cols[i];
                var x = col.x + (col.align=='start'? 0 : col.align=='end'? col.width : col.width / 2);
                this.svg.append('text')
                    .attr('class', this.css.txt_bd)
                    .attr('x', x)
                    .attr('y', this.row_height * col.row)
                    .attr('text-anchor', col.align)
                    .text(this._conv_col_name(col.name));
            }
        },
    
        _conv_col_name: function(name) {
            var ret = name;
            ret = ret.replace(/\$SM_NAME\$/g, this.cfg.sm.name);
            ret = ret.replace(/\$SM\$/g, this.cfg.sm.sm);
            return ret;
        },
    
        _draw_study_vals: function() {
            // the studies
            for (var i = 0; i < this.data.stus.length; i++) {
                var stu = this.data.stus[i];
                var g = this.svg.append('g')
                    .attr('class', this.css.stu_g)
                    .attr('transform', 'translate(0, ' + (this.row_height * (3 + i)) + ')');
    
                // add a background for display
                g.append('rect')
                    .attr('class', this.css.stu_bg)
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('width', this.width)
                    .attr('height', this.row_height);
    
                for (var j = 0; j < this.cols.length; j++) {
                    var col = this.cols[j];
                    var txt = this.get_txt_by_col(stu, j);
    
                    // special rule for the study name
                    var _txt = txt;
                    if (j == 0) {
                        if (txt.length > this.max_study_name_length) {
                            _txt = txt.substring(0, this.max_study_name_length) + ' ...'
                        }
                    }
                    var elem = g.append('text')
                        .attr('class', this.css.txt_nm)
                        .attr('x', col.x + (col.align=='start'? 0 : col.width))
                        .attr('y', this.row_height - this.row_txtmb)
                        .attr('text-anchor', col.align)
                        .text(_txt);
    
                    // bind event to the firt item
                    if (j == 0) {
                        // this is the first item
                        elem.attr('pid', stu.pid);
    
                        // add clickable style
                        elem.attr('class', this.css.txt_nm + ' ' +
                                           this.css.txt_clickable);
    
                        // add title to this element
                        if (stu.hasOwnProperty('pid')) {
                            txt = txt + ' ('+stu.pid+')';
                        }
                        elem.append('title')
                            .text(txt + '. click to check the detail in PubMed');
    
                        // bind click
                        elem.on('click', function() {
                            // var d = d3.select(this);
                            // console.log('* clicked', d);
                            var e = $(this);
                            console.log('* clicked paper', e.attr('pid'));
                            // open something?
                            if (typeof(srv_pubmed)!='undefined') {
                                srv_pubmed.show(e.attr('pid'));
                            }
                        });
                    }
                }
            }
    
            // the model result
            for (var i = 0; i < 1; i++) {
                var stu = this.data.model[this.cfg.params.fixed_or_random];
                var g = this.svg.append('g')
                    .attr('class', this.css.stu_g)
                    .attr('transform', 'translate(0, ' + (this.row_height * (4 + this.data.stus.length)) + ')');
    
                // add a background for display
                g.append('rect')
                    .attr('class', this.css.stu_bg)
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('width', this.width)
                    .attr('height', this.row_height);
                for (var j = 0; j < this.cols.length; j++) {
                    var col = this.cols[j];
                    g.append('text')
                        .attr('class', this.css.txt_bd)
                        .attr('x', col.x + (col.align=='start'? 0 : col.width))
                        .attr('y', this.row_height - this.row_txtmb)
                        .attr('text-anchor', col.align)
                        .text(this.get_txt_by_col(stu, j));
                }
            }
        },
    
        _isna: function(v) {
            if (v === null) {
                return true;
            }
            if (v === '') {
                return true;
            }
            if (v === 'NA' || v === 'na' || v === 'Na' || v === 'nA') {
                return true;
            }
            return false;
        },
    
        _draw_predition_interval: function() {
            var loc = this.data.stus.length + this.loc.prediction_interval;
            var g_predintv = this.svg.append('g')
                .attr('transform', 'translate(0, ' + (this.row_height * loc) + ')');
            var t_predintv = g_predintv.append('text')
                .attr('class', this.css.txt_nm)
                .attr('x', 0)
                .attr('y', this.row_height - this.row_txtmb)
                .attr('text-anchor', 'start');
            // add the subtext
            t_predintv.append('tspan').text('Prediction Interval:');
    
            // get the text
            var _txt = '[' + 
                this.data.model[this.cfg.params.fixed_or_random].bt_pred_lower.toFixed(2) + 
                '; ' +
                this.data.model[this.cfg.params.fixed_or_random].bt_pred_upper.toFixed(2) + 
            ']';
            // draw the lower and upper
            var col = this.cols[6];
            var elem = g.append('text')
                .attr('class', this.css.txt_nm)
                .attr('x', col.x + (col.align=='start'? 0 : col.width))
                .attr('y', this.row_height - this.row_txtmb)
                .attr('text-anchor', col.align)
                .text(_txt);
        },
    
        _draw_heter: function() {
            // show the heterogeneity
            var loc = this.data.stus.length + this.loc.heterogeneity;
            if (this.is_draw_prediction_interval) { loc += 1; }
    
            var g_heter = this.svg.append('g')
                .attr('transform', 'translate(0, ' + (this.row_height * loc) + ')');
            var t_heter = g_heter.append('text')
                .attr('class', this.css.txt_nm)
                .attr('x', 0)
                .attr('y', this.row_height - this.row_txtmb)
                .attr('text-anchor', 'start');
    
            // add the subtext
            t_heter.append('tspan').text('Heterogeneity: ');
            t_heter.append('tspan').text('I').attr('class', this.css.txt_mt);
            t_heter.append('tspan').text('2').attr('class', this.css.txt_mt + ' ' + this.css.txt_sm).attr('baseline-shift', 'super');
            t_heter.append('tspan').text('=');
            try {
                if (this._isna(this.data.model.heterogeneity.I2)) {
                    t_heter.append('tspan').text('NA');
                } else {
                    var txt_i2 = (this.data.model.heterogeneity.I2 * 100).toFixed(0) + '%';
                    t_heter.append('tspan').text(txt_i2);
                }
            } catch (err) {
                console.log(err);
                t_heter.append('tspan').text('NA');
            }
            t_heter.append('tspan').text(', ');
    
            // add tau2
            t_heter.append('tspan').text('τ');
            t_heter.append('tspan').text('2').attr('class', this.css.txt_mt + ' ' + this.css.txt_sm).attr('baseline-shift', 'super');
            t_heter.append('tspan').text('=');
            try {
                if (this._isna(this.data.model.heterogeneity.tau2)) {
                    t_heter.append('tspan').text('NA');
                } else {
                    var txt_tau2 = (this.data.model.heterogeneity.tau2).toFixed(4) 
                    t_heter.append('tspan').text(txt_tau2);
                }
            } catch (err) {
                console.log(err);
                t_heter.append('tspan').text('NA');
            }
            t_heter.append('tspan').text(', ');
    
            // add p
            t_heter.append('tspan').text('p').attr('class', this.css.txt_mt);
            t_heter.append('tspan').text('=');
            try {
                if (this._isna(this.data.model.heterogeneity.pval_Q)) {
                    t_heter.append('tspan').text('NA');
                } else {
                    var txt_p = (this.data.model.heterogeneity.pval_Q).toFixed(2) 
                    t_heter.append('tspan').text(txt_p);
                }
            } catch (err) {
                console.log(err);
                t_heter.append('tspan').text('NA');
            }
        },
    
        _draw_forest: function() {
            // dynamic range
            // var x_range = this.get_range(this.data);

            // fixed range
            var x_range = [0.01, 100];
            this.set_x_scale(x_range);
    
            this.y_scale = (function(fig){
                return function(i) {
                    return fig.row_height * (3.5 + i);
                }
            })(this);
    
            // draw the x axis
            this.xAxis = d3.axisBottom(this.x_scale)
                .ticks(this.x_axis_tick_values.length, '~g')
                .tickValues(this.x_axis_tick_values);
            this.svg.append('g')
                .attr('transform', 'translate('+(this.cols[7].x + this.row_frstml)+', '+(this.row_height * (6 + this.data.stus.length))+')')
                .call(this.xAxis);
    
            // draw the middle line
            var g_forest = this.svg.append('g')
                .attr('transform', 'translate('+(this.cols[7].x + this.row_frstml)+', 0)');
    
            g_forest.append('path')
                .datum([ [1, -0.5], [1, this.data.stus.length + 2.5] ])
                .attr('stroke', 'black')
                .attr('stroke-width', .8)
                .attr('d', d3.line()
                    .x((function(fig) {
                        return function(d) { 
                            return fig._x_scale(d[0]); 
                        }
                    })(this))
                    .y((function(fig){
                        return function(d) { 
                            return fig.y_scale(d[1]);
                        }
                    })(this))
                );
    
            // draw each study
            this.svg.selectAll('g.prim-frst-stu-item')
                .data(this.data.stus)
                .join("g")
                .attr('class', 'prim-frst-stu-item')
                .attr('transform', (function(fig){
                    return function(d, i) {
                        var trans_x = fig.cols[7].x + fig.row_frstml;
                        var trans_y = fig.y_scale(i);
                        return 'translate('+trans_x+','+trans_y+')';
                    }
                })(this))
                .each((function(fig) {
                    return function(d, i) {
                        // console.log(i, d);
                        // add the rect
                        var s = fig.min_dot_size + 
                            (fig.row_height - fig.min_dot_size) * d.w;
                    
                        var x = fig._x_scale(d.SM) - s/2;
                        var y = - s / 2;
                        d3.select(this)
                            .append('rect')
                            .attr('class', 'prim-frst-stu-rect')
                            .attr('x', x)
                            .attr('y', y)
                            .attr('width', s)
                            .attr('height', s);
        
                        // add the line
                        var x1 = fig._x_scale(d.SM_lower);
                        var x2 = fig._x_scale(d.SM_upper);
                        d3.select(this)
                            .append('line')
                            .attr('class', 'prim-frst-stu-line')
                            .attr('x1', x1)
                            .attr('x2', x2)
                            .attr('y1', 0)
                            .attr('y2', 0);
                    }
                })(this));
    
            // draw the model ref line
            var xr1 = this._x_scale(this.data.model[this.cfg.params.fixed_or_random].SM);
            var xr2 = xr1;
            var yr1 = this.y_scale(-0.5);
            var yr2 = this.y_scale(this.data.stus.length + 2.5)
            this.svg.append('g')
                .attr('transform', 'translate('+(this.cols[7].x + this.row_frstml)+', 0)')
                .append('line')
                .attr('class', 'prim-frst-stu-model-refline')
                .attr('stroke-dasharray', '3,3')
                .attr('x1', xr1)
                .attr('x2', xr2)
                .attr('y1', yr1)
                .attr('y2', yr2);
    
            // draw the model diamond
            var x0 = this._x_scale(this.data.model[this.cfg.params.fixed_or_random].SM_lower);
            var xc = this._x_scale(this.data.model[this.cfg.params.fixed_or_random].SM);
            var x1 = this._x_scale(this.data.model[this.cfg.params.fixed_or_random].SM_upper);
            var y0 = this.row_txtmb;
            var yc = this.row_height / 2;
            var y1 = this.row_height - this.row_txtmb;
            var path_d = 'M ' + 
                x0 + ' ' + yc + ' ' +
                xc + ' ' + y0 + ' ' +
                x1 + ' ' + yc + ' ' + 
                xc + ' ' + y1 + ' ' +
                'Z';
    
            this.svg.append('g')
                .attr('transform', 'translate('+(this.cols[7].x + this.row_frstml)+', '+(this.row_height * (4 + this.data.stus.length))+')')
                .append('path')
                .attr('d', path_d)
                .attr('class', 'prim-frst-stu-model');
        },
    
        get_txt_by_col: function(obj, idx) {
            switch(idx) {
                case 0: return obj.study;
                case 1: return obj.Et;
                case 2: return obj.Nt;
                case 3: return obj.Ec;
                case 4: return obj.Nc;
                case 5: return this.tf2(obj.SM);
                case 6: return '['+this.tf2(obj.SM_lower)+'; '+this.tf2(obj.SM_upper)+']';
    
                // case 7 is the figure, so no text
                case 7: return ''; 
                case 8: 
                    if (obj.hasOwnProperty('w')) {
                        // weights are depends on the random / fixed
                        return this.tf2(100*obj.w) + '%';
                    } else {
                        // this is the model
                        return '100%';
                    }
            }
            return '';
        },

        tf2: function(v) {
            if (isNaN(v)) {
                return 'NA';
            }
            return v.toFixed(2);
        },
    
        clear: function() {
            $(this.plot_id).html('');
            this.init();
        },

        hide: function() {
            $(this.box_id).hide();
        },

        get_range: function(obj) {
            var min = 1;
            var max = 2;

            // copy a new value
            var rst = JSON.parse(JSON.stringify(obj));
            
            // put the model into stus for easy loop
            rst.stus.push(rst.model);

            // check each
            for (let i = 0; i < rst.stus.length; i++) {
                const stu = rst.stus[i];
                if (stu.SM_lower < min) {
                    min = stu.SM_lower;
                }
                if (stu.SM_upper > max) {
                    max = stu.SM_upper;
                }
            }

            return [min, max];
        },

        set_x_scale: function(y_range) {
            // the min can be 0.01
            // the max can be 10
            var diff = y_range[1] - y_range[0];

            // if the diff is less than 2
            var range = [0.1, 2];
            var ticks = [0.1, 1, 2];
            var scale = d3.scaleLinear();

            if (diff < 2) {
                // nothing, just use default
            } else if (diff < 10) {
                // oh, it's pretty large
                scale = d3.scaleLog();
                range = [0.1, 10];
                ticks = [0.1, 1, 10];
            } else {
                // oh, it's pretty large
                scale = d3.scaleLog();
                range = [0.01, 100];
                ticks = [0.01, 0.1, 1, 10, 100];
            }
            
            // set the scale
            this.x_scale = scale.domain(range)
                .range([0, this.cols[7].width]);

            // set the tick values
            this.x_axis_tick_values = ticks;
        }

    };
    }
}
var fgmk_incd_forest = {

make_fig: function(box_id) {

return {
    box_id: '#' + box_id,
    plot_id: '#'+ box_id + '_svg',
    plot_type: 'd3js',
    svg: null,
    cols: [
        {width: 120, align: 'start',  name: 'Study', x: 0, row: 2},
        {width: 50,  align: 'end',    name: 'Events', row: 2},
        {width: 50,  align: 'end',    name: 'Total', row: 2},
        {width: 100,  align: 'end',    name: 'Incidence (%)', row: 2},
        {width: 100, align: 'end',    name: '95% CI', row: 2},
        {width: 200, align: 'middle', name: 'Event Rate (95% CI)', row: 2},
        {width: 100, align: 'end',    name: 'Relative weight', row: 2}
    ],
    row_height: 15,
    min_dot_size: 4,
    row_txtmb: 3,
    row_frstml: 20,
    default_height: 300,

    css: {
        txt_bd: 'prim-frst-txt-bd',
        txt_nm: 'prim-frst-txt-nm',
        txt_mt: 'prim-frst-txt-mt',
        txt_sm: 'prim-frst-txt-sm',
        stu_g: 'prim-frst-stu-g',
        stu_bg: 'prim-frst-stu-bg',
        stu_rect: 'prim-frst-stu-rect'
    },
    css_html: ["<style>",
        ".prim-frst-txt-bd{ font-weight: bold; }",
        ".prim-frst-txt-nm{ font-weight: normal; }",
        ".prim-frst-txt-mt{ font-family: Times; font-style: italic; }",
        ".prim-frst-txt-sm{ font-size: xx-small; }",
        ".prim-frst-stu-g text{ cursor: default; }",
        ".prim-frst-stu-bg{ fill: white; }",
        ".prim-frst-stu-rect{ fill: black; }",
        ".prim-frst-stu-line{ stroke: black; stroke-width: 1.5; }",
        ".prim-frst-stu-model{ fill: red; stroke: black; stroke-width: 1; }",
        ".prim-frst-stu-model-refline{ stroke: black; stroke-width: 1; }",
        ".prim-frst-stu-g:hover .prim-frst-stu-bg{ fill: whitesmoke; }",
        "</style>"
    ].join('\n'),

    _x_scale: function(v) {
        var x = this.x_scale(v);

        if (x.toString() == 'NaN') {
            return 0;
        } else {
            return x;
        }
    },

    init: function() {
        // add CSS classes
        $(this.box_id).append(this.css_html);

        // set the width of this plot
        this.width = 0;
        for (var i = 0; i < this.cols.length; i++) {
            var col = this.cols[i];
            col.x = i>0? this.cols[i-1].x + this.cols[i-1].width : 0;
            this.width += col.width;
        }
        
        // set the default height this plot
        this.height = this.default_height;

        // init the svg
        this.svg = d3.select(this.plot_id)
            .attr('width', this.width)
            .attr('height', this.height);
    },

    draw: function(data, cfg) {
        console.log('* draw incd forest data', data);
        // clear the old plot first
        this.clear();

        // bind new data
        this.data = data;
        this.cfg = cfg;

        // update the height of svg according to number of studies
        // 8 is the number of lines of header and footers
        this.height = this.row_height * (data.stus.length + 8);
        this.svg.attr('height', this.height);

        // show header
        this._draw_header();
        
        // show studies
        this._draw_study_vals();
        
        // show the model text
        this._draw_heter();

        // show the plot
        this._draw_forest();

    },

    _draw_header: function() {
        this.svg.append('text')
            .attr('class', this.css.txt_bd)
            .attr('x', this.cols[3].x)
            .attr('y', this.row_height)
            .attr('text-anchor', "end")
            .text('Treatment');
        
        for (var i = 0; i < this.cols.length; i++) {
            var col = this.cols[i];
            var x = col.x + (col.align=='start'? 0 : col.align=='end'? col.width : col.width / 2);
            this.svg.append('text')
                .attr('class', this.css.txt_bd)
                .attr('x', x)
                .attr('y', this.row_height * col.row)
                .attr('text-anchor', col.align)
                .text(this._conv_col_name(col.name));
        }
    },

    _conv_col_name: function(name) {
        var ret = name;
        ret = ret.replace(/\$SM_NAME\$/g, this.cfg.sm.name);
        ret = ret.replace(/\$SM\$/g, this.cfg.sm.sm);
        return ret;
    },

    _draw_study_vals: function() {
        // the studies
        for (var i = 0; i < this.data.stus.length; i++) {
            var stu = this.data.stus[i];
            var g = this.svg.append('g')
                .attr('class', this.css.stu_g)
                .attr('transform', 'translate(0, ' + (this.row_height * (3 + i)) + ')');

            // add a background for display
            g.append('rect')
                .attr('class', this.css.stu_bg)
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', this.width)
                .attr('height', this.row_height);

            for (var j = 0; j < this.cols.length; j++) {
                var col = this.cols[j];
                var txt = this.get_txt_by_col(stu, j);

                // special rule for the study name
                var _txt = txt;
                if (j == 0) {
                    if (txt.length > 21) {
                        _txt = txt.substring(0, 21) + ' ...'
                    }
                }
                var elem = g.append('text')
                    .attr('class', this.css.txt_nm)
                    .attr('x', col.x + (col.align=='start'? 0 : col.width))
                    .attr('y', this.row_height - this.row_txtmb)
                    .attr('text-anchor', col.align)
                    .text(_txt);
                
                // bind event to the firt item
                if (j == 0) {
                    // this is the first item
                    elem.attr('pid', stu.pid);

                    // bind click
                    elem.on('click', function() {
                        // var d = d3.select(this);
                        // console.log('* clicked', d);
                        var e = $(this);
                        console.log('* clicked paper', e.attr('pid'));
                    });
                }
            }
        }

        // the model result
        for (var i = 0; i < 1; i++) {
            var stu = this.data.model.random;
            var g = this.svg.append('g')
                .attr('class', this.css.stu_g)
                .attr('transform', 'translate(0, ' + (this.row_height * (4 + this.data.stus.length)) + ')');

            // add a background for display
            g.append('rect')
                .attr('class', this.css.stu_bg)
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', this.width)
                .attr('height', this.row_height);
            for (var j = 0; j < this.cols.length; j++) {
                var col = this.cols[j];
                g.append('text')
                    .attr('class', this.css.txt_bd)
                    .attr('x', col.x + (col.align=='start'? 0 : col.width))
                    .attr('y', this.row_height - this.row_txtmb)
                    .attr('text-anchor', col.align)
                    .text(this.get_txt_by_col(stu, j));
            }
        }
    },

    _isna: function(v) {
        if (v === null) {
            return true;
        }
        if (v === '') {
            return true;
        }
        if (v === 'NA' || v === 'na' || v === 'Na' || v === 'nA') {
            return true;
        }
        return false;
    },

    _draw_heter: function() {
        // show the heterogeneity
        var g_heter = this.svg.append('g')
            .attr('transform', 'translate(0, ' + (this.row_height * (5 + this.data.stus.length)) + ')');
        var t_heter = g_heter.append('text')
            .attr('class', this.css.txt_nm)
            .attr('x', 0)
            .attr('y', this.row_height - this.row_txtmb)
            .attr('text-anchor', 'start');

        // add the subtext
        t_heter.append('tspan').text('Heterogeneity: ');
        t_heter.append('tspan').text('I').attr('class', this.css.txt_mt);
        t_heter.append('tspan').text('2').attr('class', this.css.txt_mt + ' ' + this.css.txt_sm).attr('baseline-shift', 'super');
        t_heter.append('tspan').text('=');
        try {
            if (this._isna(this.data.heterogeneity.i2)) {
                t_heter.append('tspan').text('NA');
            } else {
                var txt_i2 = (this.data.heterogeneity.i2 * 100).toFixed(0) + '%';
                t_heter.append('tspan').text(txt_i2);
            }
        } catch (err) {
            console.log(err);
            t_heter.append('tspan').text('NA');
        }
        t_heter.append('tspan').text(', ');

        // add tau2
        t_heter.append('tspan').text('τ');
        t_heter.append('tspan').text('2').attr('class', this.css.txt_mt + ' ' + this.css.txt_sm).attr('baseline-shift', 'super');
        t_heter.append('tspan').text('=');
        try {
            if (this._isna(this.data.heterogeneity.tau2)) {
                t_heter.append('tspan').text('NA');
            } else {
                var txt_tau2 = (this.data.heterogeneity.tau2).toFixed(4) 
                t_heter.append('tspan').text(txt_tau2);
            }
        } catch (err) {
            console.log(err);
            t_heter.append('tspan').text('NA');
        }
        t_heter.append('tspan').text(', ');

        // add p
        t_heter.append('tspan').text('p').attr('class', this.css.txt_mt);
        t_heter.append('tspan').text('=');
        try {
            if (this._isna(this.data.heterogeneity.p)) {
                t_heter.append('tspan').text('NA');
            } else {
                var txt_p = (this.data.heterogeneity.p).toFixed(2) 
                t_heter.append('tspan').text(txt_p);
            }
        } catch (err) {
            console.log(err);
            t_heter.append('tspan').text('NA');
        }
    },

    _draw_forest: function() {
        // first, make the scale to map values to x value
        this.x_scale = d3.scaleLog()
            .domain([1e-2, 1e2])
            .range([0, this.cols[5].width]);

        this.y_scale = (function(fig) {
            return function(i) {
                return fig.row_height * (3.5 + i);
            }
        })(this);

        // draw the x axis
        this.xAxis = d3.axisBottom(this.x_scale)
            .ticks(5, '~g')
            .tickValues([1e-2,1e-1,1e0,1e1,1e2]);
        this.svg.append('g')
            .attr('transform', 'translate('+(this.cols[5].x + this.row_frstml)+', '+(this.row_height * (6 + this.data.stus.length))+')')
            .call(this.xAxis);

        // draw the middle line
        var g_forest = this.svg.append('g')
            .attr('transform', 'translate('+(this.cols[5].x + this.row_frstml)+', 0)');

        g_forest.append('path')
            .datum([ [1, -0.5], [1, this.data.stus.length + 2.5] ])
            .attr('stroke', 'black')
            .attr('stroke-width', .8)
            .attr('d', d3.line()
                .x((function(fig) {
                    return function(d) { 
                        return fig._x_scale(d[0]); 
                    };
                })(this))
                .y((function(fig) {
                    return function(d) { 
                        return fig.y_scale(d[1]); 
                    };
                })(this))
            );

        // draw each study
        this.svg.selectAll('g.prim-frst-stu-item')
            .data(this.data.stus)
            .join("g")
            .attr('class', 'prim-frst-stu-item')
            .attr('transform', (function(fig) {
                return function(d, i) {
                    var trans_x = fig.cols[5].x + fig.row_frstml;
                    var trans_y = fig.y_scale(i);
                    return 'translate('+trans_x+','+trans_y+')';
                };
            })(this))
            .each((function(fig) {
                return function(d, i) {
                    // console.log(i, d);
                    // add the rect
                    var s = fig.min_dot_size + 
                        (fig.row_height - fig.min_dot_size) * d.w_random;
                    var x = fig._x_scale(d.bt_ab_TE) - s/2;
                    var y = - s / 2;
                    d3.select(this)
                        .append('rect')
                        .attr('class', 'prim-frst-stu-rect')
                        .attr('x', x)
                        .attr('y', y)
                        .attr('width', s)
                        .attr('height', s);
    
                    // add the line
                    var x1 = fig._x_scale(d.bt_ab_lower);
                    var x2 = fig._x_scale(d.bt_ab_upper);
                    d3.select(this)
                        .append('line')
                        .attr('class', 'prim-frst-stu-line')
                        .attr('x1', x1)
                        .attr('x2', x2)
                        .attr('y1', 0)
                        .attr('y2', 0);
                }
            })(this));

        // draw the model ref line
        var xr1 = this._x_scale(this.data.model.random.bt_ab_TE);
        var xr2 = xr1;
        var yr1 = this.y_scale(-0.5);
        var yr2 = this.y_scale(this.data.stus.length + 2.5)
        this.svg.append('g')
            .attr('transform', 'translate('+(this.cols[5].x + this.row_frstml)+', 0)')
            .append('line')
            .attr('class', 'prim-frst-stu-model-refline')
            .attr('stroke-dasharray', '3,3')
            .attr('x1', xr1)
            .attr('x2', xr2)
            .attr('y1', yr1)
            .attr('y2', yr2);

        // draw the model diamond
        var x0 = this._x_scale(this.data.model.random.bt_ab_lower);
        var xc = this._x_scale(this.data.model.random.bt_ab_TE);
        var x1 = this._x_scale(this.data.model.random.bt_ab_upper);
        var y0 = this.row_txtmb;
        var yc = this.row_height / 2;
        var y1 = this.row_height - this.row_txtmb;
        var path_d = 'M ' + 
            x0 + ' ' + yc + ' ' +
            xc + ' ' + y0 + ' ' +
            x1 + ' ' + yc + ' ' + 
            xc + ' ' + y1 + ' ' +
            'Z';

        this.svg.append('g')
            .attr('transform', 'translate('+(this.cols[5].x + this.row_frstml)+', '+(this.row_height * (4 + this.data.stus.length))+')')
            .append('path')
            .attr('d', path_d)
            .attr('class', 'prim-frst-stu-model');
    },

    get_txt_by_col: function(obj, idx) {
        switch(idx) {
            case 0: return obj.name;
            case 1: return obj.E;
            case 2: return obj.N;
            case 3: return obj.bt_ab_TE.toFixed(2);
            case 4: return '['+obj.bt_ab_lower.toFixed(2)+'; '+obj.bt_ab_upper.toFixed(2)+']';

            // case 7 is the figure, so no text
            case 5: return ''; 
            case 6: 
                if (obj.hasOwnProperty('w')) {
                    // this is the model
                    return '100%';
                } else {
                    return (obj['w_random'] * 100).toFixed(1) + '%';
                }
        }
        return '';
    },

    clear: function() {
        $(this.plot_id).html('');
        this.init();
    }
};


}
};
var fgmk_cumu_forest = {

make_fig: function(box_id) {

return {
    box_id: '#' + box_id,
    plot_id: '#' + box_id + '_svg',
    plot_type: 'd3js',
    svg: null,
    cols: [
        {width: 200, align: 'start',  name: 'Study', x: 0, row: 1},
        {width: 200, align: 'middle', name: '$SM_NAME$ (95% CI)', row: 1},
        {width: 50,  align: 'end',    name: '$SM$', row: 1},
        {width: 100, align: 'end',    name: '95% CI', row: 1}
    ],
    row_height: 15,
    row_txtmb: 3,
    row_frstml: 20,
    default_height: 300,
    mark_size: 6,

    // the attribute name for drawing
    attr_TE: 'bt_TE',
    attr_lower: 'bt_lower',
    attr_upper: 'bt_upper',

    css: {
        txt_bd: 'cumu-frst-txt-bd',
        txt_nm: 'cumu-frst-txt-nm',
        txt_mt: 'cumu-frst-txt-mt',
        txt_sm: 'cumu-frst-txt-sm',
        txt_clickable: 'cumu-frst-txt-clickable',
        stu_g: 'cumu-frst-stu-g',
        stu_bg: 'cumu-frst-stu-bg',
        stu_rect: 'cumu-frst-stu-rect'
    },
    css_html: ["<style>",
        ".cumu-frst-txt-bd{ font-weight: bold; }",
        ".cumu-frst-txt-nm{ font-weight: normal; }",
        ".cumu-frst-txt-mt{ font-family: Times; font-style: italic; }",
        ".cumu-frst-txt-sm{ font-size: xx-small; }",
        ".cumu-frst-stu-g text{ cursor: default; }",
        ".cumu-frst-stu-bg{ fill: white; }",
        ".cumu-frst-stu-rect{ fill: black; }",
        ".cumu-frst-stu-line{ stroke: black; stroke-width: 1.5; }",
        ".cumu-frst-stu-model{ fill: red; stroke: black; stroke-width: 1; }",
        ".cumu-frst-stu-model-refline{ stroke: black; stroke-width: 1; }",
        ".cumu-frst-stu-g:hover .cumu-frst-stu-bg{ fill: whitesmoke; }",
        ".cumu-frst-txt-clickable{ fill: #00397b; cursor: pointer !important; }",
        ".cumu-frst-txt-clickable:hover{ fill: blue; }",
        "</style>"
    ].join('\n'),

    sample: {
        "model": {
        "random": {
            "TE": -0.5217,
            "lower": 0.411,
            "name": "Random effects model",
            "seTE": 0.1878,
            "sm": 0.594,
            "upper": 0.858
        }
        },
        "stus": [
        {
            "TE": -0.3978,
            "lower": 0.442,
            "name": "Adding Raskob et al (k=1)",
            "seTE": 0.2135,
            "sm": 0.672,
            "upper": 1.021
        },
        {
            "TE": -0.4875,
            "lower": 0.422,
            "name": "Adding Young et al (k=2)",
            "seTE": 0.1918,
            "sm": 0.614,
            "upper": 0.894
        },
        {
            "TE": -0.7358,
            "lower": 0.24,
            "name": "Adding McBane et al (k=3)",
            "seTE": 0.3526,
            "sm": 0.479,
            "upper": 0.956
        },
        {
            "TE": -0.5217,
            "lower": 0.411,
            "name": "Adding Young et al (k=4)",
            "seTE": 0.1878,
            "sm": 0.594,
            "upper": 0.858
        }
        ]
    },

    _x_scale: function(v) {
        var x = this.x_scale(v);

        if (x.toString() == 'NaN') {
            return 0;
        } else {
            return x;
        }
    },

    init: function() {
        // add CSS classes
        $(this.box_id).append(this.css_html);

        // set the width of this plot
        this.width = 0;
        for (var i = 0; i < this.cols.length; i++) {
            var col = this.cols[i];
            col.x = i>0? this.cols[i-1].x + this.cols[i-1].width : 0;
            this.width += col.width;
        }
        
        // set the default height this plot
        this.height = this.default_height;

        // init the svg
        this.svg = d3.select(this.plot_id)
            .attr('width', this.width)
            .attr('height', this.height);
    },

    draw: function(data, cfg) {
        // clear the old plot first
        this.clear();

        // if data is null, skip
        // because this no data
        if (data === null) {
            $(this.plot_id).html('<text y="10">There are not enough records for the cumulative plot</text>');
            return;
        }

        // bind new data
        this.data = data;
        this.cfg = cfg;

        if (this.cfg.mode == 'pwma_incd') {
            this.attr_TE = 'bt_ab_TE';
            this.attr_lower = 'bt_ab_lower';
            this.attr_upper = 'bt_ab_upper';
        } else {
            this.attr_TE = 'bt_TE';
            this.attr_lower = 'bt_lower';
            this.attr_upper = 'bt_upper';
        }

        // update the height of svg according to number of studies
        // 6 is the number of lines of header and footers
        this.height = this.row_height * (this.data.stus.length + 6.5);
        this.svg.attr('height', this.height);

        // show header
        this._draw_header();
        
        // show studies
        this._draw_study_vals();

        // show the plot
        this._draw_forest();

    },

    _draw_header: function() {
        
        for (var i = 0; i < this.cols.length; i++) {
            var col = this.cols[i];
            var x = col.x + (col.align=='start'? 0 : col.align=='end'? col.width : col.width / 2);
            this.svg.append('text')
                .attr('class', this.css.txt_bd)
                .attr('x', x)
                .attr('y', this.row_height * col.row)
                .attr('text-anchor', col.align)
                .text(this._conv_col_name(col.name));
        }
    },

    _conv_col_name: function(name) {
        var ret = name;
        ret = ret.replace(/\$SM_NAME\$/g, this.cfg.sm.name);
        ret = ret.replace(/\$SM\$/g, this.cfg.sm.sm);
        return ret;
    },

    _draw_study_vals: function() {
        // the studies
        for (var i = 0; i < this.data.stus.length; i++) {
            var stu = this.data.stus[i];
            var g = this.svg.append('g')
                .attr('class', this.css.stu_g)
                .attr('transform', 'translate(0, ' + (this.row_height * (2 + i)) + ')');

            // add a background for display
            g.append('rect')
                .attr('class', this.css.stu_bg)
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', this.width)
                .attr('height', this.row_height);

            for (var j = 0; j < this.cols.length; j++) {
                var col = this.cols[j];
                var txt = this.get_txt_by_col(stu, j);
                // special rule for the study name
                var _txt = txt;
                if (j == 0) {
                    if (txt.length > 33) {
                        _txt = txt.substring(0, 32) + ' ...'
                    }
                }

                var elem = g.append('text')
                    .attr('class', this.css.txt_nm)
                    .attr('x', col.x + (col.align=='start'? 0 : col.width))
                    .attr('y', this.row_height - this.row_txtmb)
                    .attr('text-anchor', col.align)
                    .text(_txt);

                // bind event to the first col
                if (j == 0) {
                    // this is the first col
                    elem.attr('pid', stu.pid);

                    // add clickable style
                    elem.attr('class', this.css.txt_nm + ' ' +
                                       this.css.txt_clickable);

                    // add title to this element
                    elem.append('title')
                        .text(txt);

                    // bind click
                    elem.on('click', function() {
                        // var d = d3.select(this);
                        // console.log('* clicked', d);
                        var e = $(this);
                        console.log('* clicked paper', e.attr('pid'));

                        // open something?
                        if (typeof(srv_pubmed)!='undefined') {
                            srv_pubmed.show(e.attr('pid'));
                        }
                    });
                }
            }
        }

        // the model result
        for (var i = 0; i < 1; i++) {
            var stu = this.data.model.random;
            var g = this.svg.append('g')
                .attr('class', this.css.stu_g)
                .attr('transform', 'translate(0, ' + (this.row_height * (3 + this.data.stus.length)) + ')');

            // add a background for display
            g.append('rect')
                .attr('class', this.css.stu_bg)
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', this.width)
                .attr('height', this.row_height);
            for (var j = 0; j < this.cols.length; j++) {
                var col = this.cols[j];
                g.append('text')
                    .attr('class', this.css.txt_bd)
                    .attr('x', col.x + (col.align=='start'? 0 : col.width))
                    .attr('y', this.row_height - this.row_txtmb)
                    .attr('text-anchor', col.align)
                    .text(this.get_txt_by_col(stu, j));
            }
        }
    },

    _draw_forest: function() {
        // first, make the scale to map values to x value
        this.x_scale = d3.scaleLog()
            .domain([1e-2, 1e2])
            .range([0, this.cols[1].width]);

        this.y_scale = (function(fig) {
            return function(i) {
                return fig.row_height * (2.5 + i);
            }
        })(this);

        // draw the x axis
        this.xAxis = d3.axisBottom(this.x_scale)
            .ticks(5, '~g')
            .tickValues([1e-2,1e-1,1e0,1e1,1e2]);
        this.svg.append('g')
            .attr('transform', 'translate('+(this.cols[1].x + this.row_frstml)+', '+(this.row_height * (5 + this.data.stus.length))+')')
            .call(this.xAxis);

        // draw the middle line
        var g_forest = this.svg.append('g')
            .attr('transform', 'translate('+(this.cols[1].x + this.row_frstml)+', 0)');

        g_forest.append('path')
            .datum([ [1, -0.5], [1, this.data.stus.length + 2.5] ])
            .attr('id', 'middle_line')
            .attr('stroke', 'black')
            .attr('stroke-width', .8)
            .attr('d', d3.line()
                .x((function(fig) {
                    return function(d) { 
                        return fig._x_scale(d[0]); 
                    }
                })(this))
                .y((function(fig) {
                    return function(d) { 
                        return fig.y_scale(d[1]); 
                    }
                })(this))
            );

        // draw each study
        this.svg.selectAll('g.cumu-frst-stu-item')
            .data(this.data.stus)
            .join("g")
            .attr('class', 'cumu-frst-stu-item')
            .attr('transform', (function(fig) {
                return function(d, i) {
                    var trans_x = fig.cols[1].x + fig.row_frstml;
                    var trans_y = fig.y_scale(i);
                    return 'translate('+trans_x+','+trans_y+')';
                }
            })(this))
            .each((function(fig) {
                return function(d, i) {
                    // console.log(i, d);
                    // add the rect
                    var s = fig.mark_size;
                    var x = fig._x_scale(d[fig.attr_TE]) - s/2;
                    var y = - s / 2;
                    d3.select(this)
                        .append('rect')
                        .attr('class', 'cumu-frst-stu-rect')
                        .attr('x', x)
                        .attr('y', y)
                        .attr('width', s)
                        .attr('height', s);
    
                    // add the line
                    var x1 = fig._x_scale(d[fig.attr_lower]);
                    var x2 = fig._x_scale(d[fig.attr_upper]);
                    d3.select(this)
                        .append('line')
                        .attr('class', 'cumu-frst-stu-line')
                        .attr('x1', x1)
                        .attr('x2', x2)
                        .attr('y1', 0)
                        .attr('y2', 0);
                }
            })(this));

        // draw the model ref line
        var xr1 = this._x_scale(this.data.model.random[this.attr_TE]);
        var xr2 = xr1;
        var yr1 = this.y_scale(-0.5);
        var yr2 = this.y_scale(this.data.stus.length + 2.5)
        this.svg.append('g')
            .attr('transform', 'translate('+(this.cols[1].x + this.row_frstml)+', 0)')
            .append('line')
            .attr('class', 'cumu-frst-stu-model-refline')
            .attr('stroke-dasharray', '3,3')
            .attr('x1', xr1)
            .attr('x2', xr2)
            .attr('y1', yr1)
            .attr('y2', yr2);

        // draw the model diamond
        var x0 = this._x_scale(this.data.model.random[this.attr_lower]);
        var xc = this._x_scale(this.data.model.random[this.attr_TE]);
        var x1 = this._x_scale(this.data.model.random[this.attr_upper]);
        var y0 = this.row_txtmb;
        var yc = this.row_height / 2;
        var y1 = this.row_height - this.row_txtmb;
        var path_d = 'M ' + 
            x0 + ' ' + yc + ' ' +
            xc + ' ' + y0 + ' ' +
            x1 + ' ' + yc + ' ' + 
            xc + ' ' + y1 + ' ' +
            'Z';

        this.svg.append('g')
            .attr('transform', 'translate('+(this.cols[1].x + this.row_frstml)+', '+(this.row_height * (3 + this.data.stus.length))+')')
            .append('path')
            .attr('d', path_d)
            .attr('class', 'cumu-frst-stu-model');
    },

    get_txt_by_col: function(obj, idx) {
        switch(idx) {
            case 0: return obj.name;
            // case 1 is the figure, so no text
            case 1: return '';
            case 2: return obj[this.attr_TE].toFixed(2);
            case 3: return '['+obj[this.attr_lower].toFixed(2)+'; '+obj[this.attr_upper].toFixed(2)+']';
        }
        return '';
    },

    clear: function() {
        $(this.plot_id).html('');
        this.init();
    }
};// end of fig obj
} // end of make_fig
} // end of fgmk_cumu_forest

// Alias for the pwma plots
var fg_pwma_forest = fgmk_pwma_forest.make_fig(
    'fg_pwma_forest'
);
// alias for the incidence plots
var fg_incd_incd_forest = fgmk_incd_forest.make_fig(
    'fg_incd_incd_forest'
);
// alias for the cumulative plots
var fg_cumu_forest = fgmk_cumu_forest.make_fig(
    'fg_cumu_forest'
);


var app_filter = {
    vpp: null,
    vpp_id: "#app_filter",
    blank_val: '%',

    // attrs
    attrs: [{
        display_name: 'ICI Class (Rx)',
        name: 'Class of ICI',
        values: [
            'PD1',
            'PD-L1',
            'CTLA-4'
        ]
    }, {
        display_name: 'ICI Name (Rx)',
        name: 'Name of ICI',
        values: [
            'Atezolizumab',
            'Avelumab',
            'Cemiplimab',
            'Durvalumab',
            'Ipilimumab',
            'Nivolumab',
            'Pembrolizumab',
            'Tremelimumab'
        ]
    }, {
        display_name: 'Type of Therapy (Rx)',
        name: 'Monotherapy/combination',
        values: [
            'Combination',
            'Monotherapy'
        ]
    }, {
        display_name: 'Type of combination (Rx)',
        name: 'Type of combination',
        values: [
            'ICI+ICI',
            'ICI+Chemo',
            'ICI+TKI',
            'ICI+MEKi',
            'ICI+Anti-VEGF',
            'ICI+RadiatICIn',
            'ICI+Vaccine',
            'ICI+BRAFi+MEKi',
            'ICI+Chemo+Anti-VEGF',
            'ICI+ICI+Chemo',
        ]
    }, {
        display_name: 'Control Arm',
        name: 'Type of control',
        values: [
            'Chemo',
            'TKI',
            'Interferon',
            'Multikinase inhibitor',
            'mTOR inhibitor',
            'Radiation',
            'Vaccine',
            'Placebo',
            'Chemo/Anti-EGFR',
            'Chemo+Anti-VEGF',
            'Chemo/TKI',
            'BRAFi+MEKi',
            'Best supportive care'
        ]
    }, {
        display_name: 'Cancer Type',
        name: 'Cancer type',
        values: [
            'Bladder',
            'Breast',
            'Colorectal',
            'Esophageal/GEJ',
            'Gastric/GEJ',
            'Head and Neck ',
            'Hepatocellular',
            'Melanoma',
            'Mesothelioma',
            'Multiple Myeloma',
            'Non-Small Cell Lung',
            'Pancreatic',
            'Prostate',
            'Renal cell',
            'Small Cell Lung',
            'Urothelial'
        ]
    }],

    // the data is for the 
    init: function(data) {

        // create a new list of attrs
        var dropdowns = [];
        for (let i = 0; i < this.attrs.length; i++) {
            const attr = this.attrs[i];
            dropdowns.push({
                display_name: attr.display_name,
                name: attr.name,
                value: '%',
                options: this._get_options(i, true)
            });
        }

        // put the default values
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                dropdowns: dropdowns,
                n_papers: data.rs.length
            },
            methods: {
                is_filter_disabled: function(idx) {
                    if (idx == 0) {
                        return false;
                    } else {
                        if (idx == 1 || idx == 2 || idx == 5) {
                            
                            if (this.dropdowns[idx-1].value == '%') {
                                return true;
                            } else {
                                return false;
                            }
                        }

                        // for the Type of combination
                        // this dropdown depends on the value of previous
                        if (idx == 3) {
                            if (this.dropdowns[2].value.toLocaleLowerCase() == 'combination') {
                                return false;
                            } else {
                                return true;
                            }
                        }

                        // for the next, it depends on the m/c value
                        // and also the choose of type of comb
                        if (idx == 4) {
                            if (this.dropdowns[2].value == '%') {
                                return true;
                            } else if ( this.dropdowns[2].value == 'all' ||
                                this.dropdowns[2].value.toLocaleLowerCase() == 'monotherapy') {
                                return false;  
                            } else {
                                // depends on the value of 
                                if (this.dropdowns[3].value == '%') {
                                    return true;
                                } else {
                                    return false;
                                }
                            }
                        }
                    }
                },

                on_filter_value_change: function(event, idx) {
                    var new_val = event.target.value;
                    this.set_value_at(new_val, idx, true);
                },

                get_current_values: function() {
                    var vals = [];
                    for (let i = 0; i < this.dropdowns.length; i++) {
                        var val = this.dropdowns[i].value;
                        vals.push(val);
                    }
                    return vals;
                },

                set_value_at: function(new_val, idx, update_related_views) {
                    if (typeof(update_related_views) == 'undefined') {
                        update_related_views = false;
                    }

                    this.dropdowns[idx].value = new_val;

                    // update the affected
                    if (idx < this.dropdowns.length - 1) {
                        // now, reset all of the following options
                        for (let i = idx + 1; i < this.dropdowns.length; i++) {
                            // reset the value
                            this.dropdowns[i].value = '%';
                            // reset the options
                            this.dropdowns[i].options = app_filter._get_options(i, true);
                        }
                        
                        if (new_val != '%') {
                            // now, update the options of the next dropdown
                            var next = 1;
                            if (idx == 2 &&
                                new_val.toLocaleLowerCase() == 'all') {
                                next = 2;
                            }
                            if (idx == 2 &&
                                new_val.toLocaleLowerCase() == 'monotherapy') {
                                next = 2;
                            }
                            
                            var next_options = app_filter._get_options(idx + next);
                            // console.log(next_options);
                            this.dropdowns[idx + next].options = next_options;
                        }
                    }

                    // now need to get the pmids
                    // so, first, get the current values of all dropdowns
                    var conditions = [];
                    for (let i = 0; i < this.dropdowns.length; i++) {
                        const dropdown = this.dropdowns[i];
                        var name_i = dropdown.name;
                        var val_i = dropdown.value;
                        if (val_i == '%' || val_i == 'all') {
                            // skip the default
                            // but we still need a condition, so this one
                            conditions.push(
                                '1=1'
                            );
                        } else {
                            conditions.push(
                                '`' + name_i + '` like "%' + val_i + '%"'
                            );
                        }
                    }
                    // second, use the conditions to search for the 
                    var pmids = app_filter._get_pmids_by_conditions(conditions);
                    this.n_papers = pmids.length;
                    // finally, update the filter UI
                    this.$forceUpdate();

                    if (update_related_views) {
                        // console.log('* filtered studies:', pmids);

                        // send these pmids to the oclist
                        jarvis.update_plots_by_pmids(pmids);

                    }
                },
            
                set_values: function(vals) {
                    for (let i = 0; i < vals.length; i++) {
                        const val = vals[i];
                        
                        // set all values
                        if (i == (vals.length - 1)) {
                            // update the last one
                            this.set_value_at(val, i, true);
                        } else {
                            this.set_value_at(val, i, false);
                        }
                    }
                }
            }
        });
    },

    update: function() {
        this.vpp.$data.attrs = attrs;
    },

    _get_pmids_by_conditions: function(conditions) {
        var sql_conds = conditions.join(' and \n');
        var sql = "select PMID from papers " + '\n' +
            "where " + sql_conds + '\n';
        
        var rs = alasql(sql);
        
        var pmids = [];
        for (let i = 0; i < rs.length; i++) {
            const r = rs[i];
            // make sure the PMID is a string
            pmids.push(""+r.PMID);
        }

        return pmids;
    },

    _get_options: function(idx, skip) {
        if (typeof(skip) == 'undefined') {
            // use this option to skip checking, just return the default options
            skip = false;
        }
        var options = [{
            name: '',
            value: '%'
        }, {
            name: 'All',
            value: 'all'
        }];
        var name_idx = this.attrs[idx].name;
        var vals_idx = this.attrs[idx].values;

        if (idx == 0) {
            for (let i = 0; i < this.attrs[idx].values.length; i++) {
                const val = this.attrs[idx].values[i];
                options.push({
                    name: val,
                    value: val
                })
            }
        } else {
            if (skip) {
                return options;
            }
            // for all other dropdown, the option is decided by ALL of the selections
            // of dependencies for example:
            // for the 2nd dropdown, the options are decided by the 1st selection
            // for the 3rd dropdown, the options are decided by the selections of the 1st and 2nd.
            // for the 4th, by 1st, 2nd, and 3rd
            // etc.
            // So, first, need to generate the condition by all previous 
            var conditions = [];
            for (let j = 0; j < idx; j++) {
                var name_j = this.vpp.$data.dropdowns[j].name;
                var val_j = this.vpp.$data.dropdowns[j].value;

                if (val_j == this.blank_val || val_j == 'all') {
                    // skip the blank dropdown
                    // but we still need a condition, so this one
                    conditions.push(
                        '1=1'
                    );
                } else {
                    conditions.push(
                        '`' + name_j + '` like "%' + val_j + '%"'
                    );
                }
            }
            var sql_cond = conditions.join(' and \n');

            // then, use these conditions to query the itable data to get the available records
            var sql = "select `" + name_idx + '` as attr, count(PMID) as cnt ' + '\n' +
                'from papers ' + '\n' +
                'where ' + sql_cond + '\n' +
                'group by `' + name_idx + '` ';

            console.log(sql);
            var rs = alasql(sql);
            console.log(rs);

            // last, check each value whether available in the rs
            for (let i = 0; i < this.attrs[idx].values.length; i++) {
                const val = this.attrs[idx].values[i];
                var val_upper = val.toLocaleUpperCase();

                // check whether this val in rs or not
                for (let j = 0; j < rs.length; j++) {
                    const r = rs[j];

                    if (typeof(r.attr) == 'undefined' ||
                        r.attr == null) {
                        continue;
                    }
                    
                    var R_VAL = r.attr.toLocaleUpperCase();
                    
                    if (R_VAL.lastIndexOf(val_upper)>=0) {
                        // which means this value exists in the selection
                        // Then we could put this val in the result
                        options.push({
                            name: val,
                            value: val
                        });
                        
                        // since we already found this value
                        // just break and check next value
                        break;

                    } else {
                        
                    }
                }
            }
        }

        return options;
    },

    cmp_val: function(a, b) {
        if (a == b) {
            return true;

        } else if (a == '%') {
            if (b == 'all') {
                return true;
            }
        } else if (a == 'all') {
            if (b == '%') {
                return true;
            }
        }

        return false;
    },

    cmp_vals: function(va, vb) {
        for (let i = 0; i < va.length; i++) {
            const a = va[i];
            const b = vb[i];
            if (this.cmp_val(a, b)) {
                // ok
            } else {
                return false;
            }
        }
        return true;
    }
};


var app_oclist = {
    vpp: null,
    vpp_id: '#app_oclist',
    select_mode: 'checkbox', // radio, checkbox
    pids: [],

    init: function(data) {
        // bind local data
        this.data = data;

        // update the ocd
        var ocds = this.update_oc_dicts(data);
        this.oc_dict = ocds.oc_dict;
        this.oc_dict3 = ocds.oc_dict3;
        
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                group: 'treatment',
                
                select_mode: this.select_mode,

                color_mode_by_sm: 'RR',

                // rs is a three level dict
                // {
                //     group: {
                //         oc_group,
                //         is_close,
                //         cates: {
                //             cate_name: {
                //                 oc_cate,
                //                 aes: []
                //             }
                //         }
                //     }
                // },
                rs: {},
                rs_stat: {
                    cnt_cates: 0,
                    cnt_aes: 0,
                },
                ma_dict: {},

                keyword: '',

                // for filter number of outcomes
                cnt_rule: 'ge1'
            },
            methods: {
                n_all: function() {
                    var n = 0;
                    for (const key in this.rs) {
                        if (Object.hasOwnProperty.call(this.rs, key)) {
                            const group = this.rs[key];
                            n += this.n_group(group);
                        }
                    }
                    return n;
                },

                n_group: function(group) {
                    var n = 0;
                    for (const key in group.cates) {
                        const cate = group.cates[key];
                        n += this.n_cate(cate);
                    }

                    return n;
                },

                n_cate: function(cate) {
                    var n = 0;
                    for (let i = 0; i < cate.aes.length; i++) {
                        const ae = cate.aes[i];
                        if (this.show_oc(ae) && this.match_keyword(ae.oc_name)) {
                            n += 1;
                        }
                    }
                    return n;
                },

                match_keyword: function(s) {
                    if (this.keyword.length < 3) {
                        return true;
                    }

                    if (s.toUpperCase().indexOf(this.keyword.toUpperCase())>=0) {
                        return true;
                    }

                    return false;
                },

                match_keyword_in_cate(cate) {
                    for (let i = 0; i < cate.aes.length; i++) {
                        const ae = cate.aes[i];
                        
                        if (this.match_keyword(ae.oc_name)) {
                            return true;
                        }
                    }

                    return false;
                },

                is_cnt_ok: function(cnt) {
                    if (this.cnt_rule == 'ge1') {
                        if (cnt >= 1) {
                            return true;
                        }
                    } else if (this.cnt_rule == 'ge5') {
                        if (cnt >= 5) {
                            return true;
                        }
                    } else if (this.cnt_rule == 'ge10') {
                        if (cnt >= 10) {
                            return true;
                        }
                    } else if (this.cnt_rule == 'ge20') {
                        if (cnt >= 20) {
                            return true;
                        }
                    } else if (this.cnt_rule == 'ge1ls5') {
                        if (cnt >= 1 && cnt < 5) {
                            return true;
                        }
                    } else if (this.cnt_rule == 'ge5ls10') {
                        if (cnt >= 5 && cnt < 10) {
                            return true;
                        }
                    } else if (this.cnt_rule == 'ge10ls20') {
                        if (cnt >= 10 && cnt < 20) {
                            return true;
                        }
                    }

                    return false;
                },
                
                show_oc: function(ae) {
                    var gs = ['ga', 'g3h', 'g5n'];
                    for (let i = 0; i < gs.length; i++) {
                        if (this.show_oc_grade(ae, gs[i])) {
                            return true;
                        }
                    }
                    return false;
                },

                show_oc_grade: function(ae, grade) {
                    if (typeof(grade) == 'undefined') {
                        grade = 'GA';
                    }
                    var _g = grade.toLocaleLowerCase();

                    if (this.is_cnt_ok(ae['cnt_'+ _g])) {
                        return true;
                    }
                    return false;
                },

                add_group: function(group, ae_grade) {
                    var cnt = 0;
                    var ret = window.confirm(
                        'Adding ALL '+ae_grade+' outcomes in current ['+group.oc_group+'] group may take a while, are sure to continue?'
                    );
                    if (ret) {

                    } else {
                        return cnt;
                    }

                    for (const cate_name in group.cates) {
                        if (Object.hasOwnProperty.call(group.cates, cate_name)) {
                            const cate = group.cates[cate_name];
                            cnt += this.add_cate(cate, ae_grade);
                        }
                    }

                    console.log('* finished add group of ' + cnt);
                    return cnt;
                },

                add_cate: function(cate, ae_grade) {
                    // the cate contains all AE
                    var cnt = 0;
                    for (let i = 0; i < cate.aes.length; i++) {
                        const ae = cate.aes[i];
                        
                        if (this.match_keyword(ae.oc_name)) {
                            cnt += this.add_oc(
                                ae,
                                ae_grade
                            );
                        }
                    }

                    return cnt;
                },

                add_oc: function(ae, ae_grade, count) {
                    if (this.show_oc_grade(ae, ae_grade)) {

                    } else {
                        // this oc can NOT be displayed for some reason
                        // so won't be added for comparison
                        console.log('* failed to add_oc by show_oc_grade', ae);
                        return 0;
                    }

                    if (typeof(count) == 'undefined') {

                    } else {
                        // just for counting
                        return 1;
                    }
                    // var group = this.group;
                    // var oc_abbr = event.target.getAttribute('oc_abbr');
                    // var oc_cate = event.target.getAttribute('oc_cate');
                    // var oc_name = event.target.getAttribute('oc_name');
                    // var ae_grade = event.target.getAttribute('ae_grade');

                    // add effect
                    // if (this.select_mode == 'checkbox') {
                    //     $(event.target).toggleClass('oc-type-selected');
                    // } else {
                    //     $('.oc-type').removeClass('oc-type-selected');
                    //     $(event.target).addClass('oc-type-selected');
                    // }

                    // call the worker to update everything related
                    // jarvis will do this task accordingly
                    return jarvis.add_oc(
                        ae.oc_group, 
                        ae.oc_cate, 
                        ae.oc_name, 
                        ae.oc_abbr, 

                        ae_grade, 
                        app_oclist.pids
                    );
                },

                get_grade_label: function(g) {
                    return jarvis.texts[g];
                },

                toggle_group: function(group) {
                    this.rs[group].is_close = !this.rs[group].is_close;
                },

                toggle_cate: function(group, cate) {
                    this.rs[group].cates[cate].is_close = !this.rs[group].cates[cate].is_close;
                },

                toggle_all_cates: function(flag) {
                    for (var key in this.rs) {
                        this.rs[key].is_close = flag;
                    }
                },

                get_eft_color: function(d) {
                    return jarvis.get_color(
                        d.random.SM,
                        d.random.SM_lower,
                        d.random.SM_upper,
                    )
                },

                clear: function() {
                    $('.oc-type').removeClass('oc-type-selected');
                    jarvis.clear_all_ae();
                },

                update_oclist: function() {
                    app_oclist.update();

                    // when update the oclist, should hide the current img
                    // vw_ocplot.hide_plot();

                    this.clear();
                }
            }
        });

        this.update([]);
    },

    get_pid_condition: function(pids, group) {
        var conditions = '';
        // so first condition is the pid
        if (pids.length == 0) {
            conditions += 'pid is not null ';
        } else {
            var cond = pids.map(function(v) { return '"' + v + '"'}).join(',');
            conditions += 'pid in (' + cond + ') ';
        }

        // second condition is the group
        // var group = this.vpp.$data.group;
        if (typeof(group) == 'undefined') {

        } else {
            // conditions += '\n';
            // conditions += 'and oc_group = "'+group+'" ';
        }

        return conditions;
    },
    
    update: function(pids) {
        if (typeof(pids) == 'undefined') {

        } else {
            // update the pid
            this.pids = pids;
        }

        // get updated rs for oc list
        var oc_list = this.update_ocs(
            pids,
            this.vpp.$data.group
        );
        
        // bind results 
        // this.raw_rs = raw_rs;
        this.oc_list = oc_list.rs;
        this.rs_stat = oc_list.rs_stat;


        // update vpp data
        this.vpp.rs = oc_list.rs;
        this.vpp.rs_stat = oc_list.rs_stat;

        // get updated MAs
        var ma_dict = this.update_ma_dict(
            pids,
            this.vpp.$data.group
        );

        // update the MA results
        this.update_ma_rsts(
            ma_dict
        );
        this.ma_dict = ma_dict;
        this.vpp.ma_dict = ma_dict;

        // convert to dataframe for display
        var ma_df = this.update_ma_df(
            ma_dict,
            this.oc_dict
        );
        this.ma_df = ma_df;

        // update the vis
        var vis_data = this.update_vis_data(
            ma_df,
            this.oc_dict
        );
        vis_ocmas.draw_fig_scatter(
            vis_data
        );
        vis_ocmas.draw_fig_heatmap(
            this.oc_dict3
        );
        vis_ocmas.draw_fig_sunburst(
            this.oc_dict3,
            this.ma_dict
        );

        // update tips
        $(document).tooltip({
            position: {
                my: "left top",
                at: "right+5 top-5",
                collision: "none"
            }
        });
    },

    update_oc_dicts: function() {
        var sql = 'select oc_group, oc_cate, oc_abbr, first(oc_name) as oc_name, ' + '\n' +
            '  count(case when has_GA = true then pid else null end) as cnt_ga, ' + '\n' +
            '  count(case when has_G3H = true then pid else null end) as cnt_g3h, ' + '\n' +
            '  count(case when has_G5N = true then pid else null end) as cnt_g5n ' + '\n' +
            'from aes ' + '\n' +
            'group by oc_group, oc_cate, oc_abbr ' + '\n' +
            'order by oc_group asc, oc_cate asc, oc_name asc';

        var raw_rs = alasql(sql);

        // oc_dict3 is a three level dict
        // {
        //      group: { cate: { abbr: {}}}
        // }
        // oc_dict2 is a one level dict
        // {
        //      abbr: {}
        // }
        
        var oc_dict = {};
        var oc_dict3 = {};

        for (var i = 0; i < raw_rs.length; i++) {
            var r = raw_rs[i];

            if (typeof(r.oc_cate) == 'undefined' ||
                r.oc_cate == null) {
                continue;
            }

            // first, update this abbr in one-level dict
            if (!oc_dict.hasOwnProperty(r.oc_abbr)) {
                oc_dict[r.oc_abbr] = {
                    oc_group: r.oc_group,
                    oc_cate: r.oc_cate,
                    oc_abbr: r.oc_abbr,
                    oc_name: r.oc_name,
                    cnt_ga: r.cnt_ga,
                    cnt_g3h: r.cnt_g3h,
                    cnt_g5n: r.cnt_g5n
                }
            }

            // second, update this abbr in three-level dict
            if (!oc_dict3.hasOwnProperty(r.oc_group)) {
                oc_dict3[r.oc_group] = {}
            }

            if (!oc_dict3[r.oc_group].hasOwnProperty(r.oc_cate)) {
                oc_dict3[r.oc_group][r.oc_cate] = {}
            }

            if (!oc_dict3[r.oc_group][r.oc_cate].hasOwnProperty(r.oc_abbr)) {
                
                oc_dict3[r.oc_group][r.oc_cate][r.oc_abbr] = {
                    oc_group: r.oc_group,
                    oc_cate: r.oc_cate,
                    oc_abbr: r.oc_abbr,
                    oc_name: r.oc_name,
                    cnt_ga: r.cnt_ga,
                    cnt_g3h: r.cnt_g3h,
                    cnt_g5n: r.cnt_g5n,
                    // this is for In-Cate-IndeX
                    icix: Object.values(oc_dict3[r.oc_group][r.oc_cate]).length
                }
            }
        }

        return {
            oc_dict: oc_dict,
            oc_dict3: oc_dict3
        };
    },

    update_ocs: function(pids, group) {
        var sql = 'select oc_group, oc_cate, oc_abbr, first(oc_name) as oc_name, ' + '\n' +
            '  count(case when has_GA = true then pid else null end) as cnt_ga, ' + '\n' +
            '  count(case when has_G3H = true then pid else null end) as cnt_g3h, ' + '\n' +
            '  count(case when has_G5N = true then pid else null end) as cnt_g5n ' + '\n' +
            'from aes ' + '\n' +
            'where ' + '\n' +
            this.get_pid_condition(pids, group) + ' ' + '\n' +
            'group by oc_group, oc_cate, oc_abbr ' + '\n' +
            'order by oc_group desc, oc_cate asc, oc_name asc';

        // console.log(sql);
        // init the result
        var raw_rs = alasql(sql);
        // console.log("* raw_rs", raw_rs);

        var rs = {};
        var rs_stat = {
            cnt_cates: 0,
            cnt_aes: 0,
        };
        for (var i = 0; i < raw_rs.length; i++) {
            var r = raw_rs[i];

            if (typeof(r.oc_group) == 'undefined' ||
                r.oc_group == null) {
                continue;
            }

            if (typeof(r.oc_cate) == 'undefined' ||
                r.oc_cate == null) {
                continue;
            }
            
            // add group first
            if (rs.hasOwnProperty(r.oc_group)) {
                //
            } else {
                rs[r.oc_group] = {
                    oc_group: r.oc_group,
                    is_close: false,
                    cates: {}
                }
                rs_stat.cnt_cates += 1;
            }
            
            if (rs[r.oc_group].cates.hasOwnProperty(r.oc_cate)) {
                //
            } else {
                rs[r.oc_group].cates[r.oc_cate] = {
                    oc_cate: r.oc_cate,
                    is_close: false,
                    aes: []
                }
                rs_stat.cnt_cates += 1;
            }
            // put this ae into cate
            rs[r.oc_group].cates[r.oc_cate]['aes'].push({
                oc_group: r.oc_group,
                oc_cate: r.oc_cate,
                oc_name: r.oc_name,
                oc_abbr: r.oc_abbr,

                cnt_ga: r.cnt_ga,
                cnt_g3h: r.cnt_g3h,
                cnt_g5n: r.cnt_g5n
            });
            rs_stat.cnt_aes += 1;
        }

        return {
            rs: rs,
            rs_stat: rs_stat
        };
    },

    update_ma_dict: function(pids, group) {
        var sql = 'select * ' + '\n' +
            'from aes ' + '\n' +
            'where ' + '\n' +
            this.get_pid_condition(pids);

        var rs = alasql(sql);
        console.log('* rs for mas:', rs);

        // the dict for final records and MA results
        var ma_dict = {};

        for (let i = 0; i < rs.length; i++) {
            const r = rs[i];
            
            if (!ma_dict.hasOwnProperty(r.oc_abbr)) {
                // Oh, no such record yet, save it
                ma_dict[r.oc_abbr] = {
                    GA: { PRIM: { total: [0,0,0,0], stus: [], rsts: {} }, INCD: { total: [0,0,0,0], stus: [], rsts: {} } },
                    G3H: { PRIM: { total: [0,0,0,0], stus: [], rsts: {} }, INCD: { total: [0,0,0,0], stus: [], rsts: {} } },
                    G5N: { PRIM: { total: [0,0,0,0], stus: [], rsts: {} }, INCD: { total: [0,0,0,0], stus: [], rsts: {} } },
                }
            }

            // now check each grade
            for (let j = 0; j < 3; j++) {
                var grade = {0: 'GA', 1: 'G3H', 2: 'G5N'}[j];
                
                if (r['has_'+grade+'_prim']) {
                    // ok, this has grade prim data
                    ma_dict[r.oc_abbr][grade].PRIM.stus.push([
                        r[grade+'_Et'],
                        r['GA_Nt'],
                        r[grade+'_Ec'],
                        r['GA_Nc'],
                        r['author'],
                        'T',
                        'C',
                        // add more infor vis
                        r['pid'],
                        r['year'],
                    ]);
                    ma_dict[r.oc_abbr][grade].PRIM.total = math.add(
                        ma_dict[r.oc_abbr][grade].PRIM.total,
                        [
                            r[grade+'_Et'],
                            r['GA_Nt'],
                            r[grade+'_Ec'],
                            r['GA_Nc'],
                        ]
                    );
                }
                
                // add incidence analysis
                if (r['has_'+grade+'_incd']) {
                    // ok, this has grade prim data
                    ma_dict[r.oc_abbr][grade].INCD.stus.push([
                        r[grade+'_Et'],
                        r['GA_Nt'],
                        r[grade+'_Ec'],
                        r['GA_Nc'],
                        r['author'],
                        'T',
                        'C',
                        // add more infor vis
                        r['pid'],
                        r['year'],
                    ]);
                    ma_dict[r.oc_abbr][grade].INCD.total = math.add(
                        ma_dict[r.oc_abbr][grade].INCD.total,
                        [
                            r[grade+'_Et'],
                            r['GA_Nt'],
                            0,
                            0,
                        ]
                    );
                }
            }
        }

        return ma_dict;
    },


    mk_data_cfg_by_ma: function(ma_prim, sm, fixed_or_random) {
        if (typeof(fixed_or_random) == 'undefined') {
            fixed_or_random = 'random';
        }
        var stus = [];
        var model = {};
        var cfg = {
            sm: {
                'OR': { sm: 'OR', name: 'Odds Ratio' },
                'RR': { sm: 'RR', name: 'Risk Ratio' },
            }[sm],
            mode: 'pwma_prcm',
            params: {
                input_format: 'PRIM_CAT_RAW',  // or PRIM_CAT_PRE
                fixed_or_random: fixed_or_random,     // or fixed
                prediction_interval: false,    // or true
            }
        };

        // update stus
        for (let i = 0; i < ma_prim.stus.length; i++) {
            const _stu = ma_prim.stus[i];
            stus.push({
                Et: _stu[0],
                Nt: _stu[1],
                Ec: _stu[2],
                Nc: _stu[3],
                study: _stu[4],
                treatment: _stu[5],
                control: _stu[6],
                pid: _stu[7],
                year: _stu[8],

                // MA information
                SM: ma_prim.rsts[sm].SM[i],
                SM_lower: ma_prim.rsts[sm].SM_lower[i],
                SM_upper: ma_prim.rsts[sm].SM_upper[i],
                w: ma_prim.rsts[sm][fixed_or_random].wp[i]
            });
        }

        // update the model
        model = JSON.parse(JSON.stringify(ma_prim.rsts[sm]));

        // just for display in forest plot
        model[fixed_or_random].study = jarvis.capitalize(fixed_or_random) + ' effects model';
        model[fixed_or_random].Et = ma_prim.total[0];
        model[fixed_or_random].Nt = ma_prim.total[1];
        model[fixed_or_random].Ec = ma_prim.total[2];
        model[fixed_or_random].Nc = ma_prim.total[3];
        model[fixed_or_random].w = 1;

        var ret = {
            data: {
                stus: stus,
                model: model
            },
            cfg: cfg
        };

        return ret;
    },

    update_ma_rsts: function(ma_dict) {
        // mark start time
        const t0 = performance.now();
        var cnt_mas = 0;

        // let's check 
        for (const abbr in ma_dict) {
            for (const grade in ma_dict[abbr]) {
                // get prim data
                var ma_prim = ma_dict[abbr][grade].PRIM;
                var ma_incd = ma_dict[abbr][grade].INCD;

                if (ma_prim.stus.length != 0) {
                    // OK, let's do INCD ANA
                    var rst_OR = metajs.metabin(
                        ma_prim.stus, {
                            sm: 'OR'
                        }
                    );

                    var rst_RR = metajs.metabin(
                        ma_prim.stus, {
                            sm: 'RR'
                        }
                    );

                    // update the data
                    ma_dict[abbr][grade].PRIM.rsts = {
                        OR: rst_OR,
                        RR: rst_RR
                    };

                    // update count
                    cnt_mas += 2;
                }

                if (ma_incd.stus.length != 0) {
                    // OK, let's do INCD ANA
                    var rst_INCD = metajs.metaprop(
                        ma_incd.stus, {}
                    );

                    // update the data
                    ma_dict[abbr][grade].INCD.rsts = {
                        INCD: rst_INCD
                    };

                    // update the total count
                    cnt_mas += 1;
                }
            }
        }

        // get the total time
        const t1 = performance.now();
        const dur = (t1 - t0) / 1000;

        console.log('* finished calculation of ' + cnt_mas + ' MAs in ' + dur.toFixed(4) + ' seconds');

        return ma_dict;
    },

    update_ma_df: function(ma_dict, oc_dict) {
        const t0 = performance.now();
        // I guess we need 
        var rs = [];
        for (const abbr in ma_dict) {
            for (const grade in ma_dict[abbr]) {
                // get prim data
                var ma_prim = ma_dict[abbr][grade].PRIM;
                var ma_incd = ma_dict[abbr][grade].INCD;

                // put primary
                var r = {
                    abbr: abbr,
                    name: oc_dict[abbr].oc_name,
                    grade: grade
                };
                if (ma_prim.stus.length == 0) {
                    Object.assign(r, {
                        // values
                        OR_n_stus: 0,
                        OR_sm: NaN,
                        OR_lower: NaN,
                        OR_upper: NaN,
                    });
                } else {
                    Object.assign(r, {
                        // values
                        OR_n_stus: ma_prim.stus.length,
                        OR_sm: ma_prim.rsts.OR.random.SM,
                        OR_lower: ma_prim.rsts.OR.random.SM_lower,
                        OR_upper: ma_prim.rsts.OR.random.SM_upper,
                    });
                }

                // put incidence
                if (ma_incd.stus.length == 0) {
                    Object.assign(r, {
                        // values
                        INCD_n_stus: 0,
                        INCD_sm: NaN,
                        INCD_lower: NaN,
                        INCD_upper: NaN,
                    });
                } else {
                    Object.assign(r, {
                        // values
                        INCD_n_stus: ma_incd.stus.length,
                        INCD_sm: ma_incd.rsts.INCD.random.SM,
                        INCD_lower: ma_incd.rsts.INCD.random.SM_lower,
                        INCD_upper: ma_incd.rsts.INCD.random.SM_upper,
                    });
                }

                rs.push(r);
            }
        }

        var df = new dfd.DataFrame(rs);

        // get the total time
        const t1 = performance.now();
        const dur = (t1 - t0) / 1000;

        console.log('* finished converting ' + rs.length + ' MAs to in ' + dur.toFixed(4) + ' seconds');

        return df;
    },

    update_vis_data: function(df) {
        var cols = [
            'INCD_sm',
            'OR_sm', 
            'name',
            'grade',
            'OR_n_stus',
            'OR_lower',
            'OR_upper',
            'INCD_lower',
            'INCD_upper',
        ];
        var data_ga = df.loc({
            rows: df['OR_n_stus'].gt(0).and(
                df['grade'].eq('GA')
            ),
            columns: cols
        }).values;

        var data_g3h = df.loc({
            rows: df['OR_n_stus'].gt(0).and(
                df['grade'].eq('G3H')
            ),
            columns: cols
        }).values;

        var data_g5n = df.loc({
            rows: df['OR_n_stus'].gt(0).and(
                df['grade'].eq('G5N')
            ),
            columns: cols
        }).values;

        return {
            data_ga: data_ga,
            data_g3h: data_g3h,
            data_g5n: data_g5n
        };
    }
};


var app_comptb = {
    vpp: null,
    vpp_id: '#app_comptb',

    x_scale: {
        sm: {
            log: d3.scaleLog()
                .domain([1e-2, 1e2])
                .range([0, 120]),
            linear: d3.scaleLinear()
                .domain([0, 1])
                .range([0, 120]),
        },
        
        lg: {
            log: d3.scaleLog()
                .domain([1e-2, 1e2])
                .range([0, 360]),
            linear: d3.scaleLinear()
                .domain([0, 1])
                .range([0, 360]),
        },
    },
    
    init: function() {
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                // the full ocs for comparison
                f_ocs: [],

                // show which result
                show_effect_model: 'random',

                // show how many measures
                show_measure: 'all',

                // show which one?
                measure_of_effect: 'OR',

                // show label
                show_effect_label: true,

                // checking detail
                detail_f_oc: null,

                // sort
                sort_ocs_by: 'default',

                // order
                default_sort_ocs_order: 'asc'
            },
            methods: {
                _txt: function(s, type) {
                    if (typeof(type) == 'undefined') {
                        return s;
                    }
                    // for grade
                    if (type == 'grade') {
                        return {
                            'GA': 'ALL',
                            'G3H': '3+',
                            'G5N': '5'
                        }[s];

                    } else if (type == 'filter') {
                        if (s == '%' || s == 'all') {
                            return 'ALL'
                        } else {
                            return s;
                        }

                    } else {
                        return s;
                    }
                },

                _txt_cancer: function(f_vals) {
                    if (f_vals[5] == '%' || f_vals[5] == 'all') {
                        return 'ALL CANCERS';
                    } else {
                        return f_vals[5];
                    }
                },

                _txt_treat: function(f_vals) {
                    var txt = this._txt(f_vals[0], 'filter') + 
                               '.' +
                               this._txt(f_vals[1], 'filter');

                    if (f_vals[2] == '%' || f_vals[2] == 'all') {
                        
                        if (f_vals[1] == '%' || f_vals[1] == 'all') {
                            return txt;
                        } else {
                            
                            return txt + ' (ALL)';
                        }
                        
                    } else if (f_vals[2] == 'Monotherapy') {
                        // mono
                        return txt + ' (MONO)';

                    } else {
                        // comb
                        if (f_vals[3] == '%' || f_vals[3] == 'all') {
                            // all comb
                            return txt + ' (COMB)';
                        } else {
                            // specific comb
                            return txt + ' (' + this._txt(f_vals[3], 'filter') + ')';
                        }
                    }
                },

                set_sort_ocs_by: function(sort_by) {
                    this.sort_ocs_by = sort_by;
                },
                
                get_sort_ocs_by: function() {
                    if (this.hasOwnProperty('sort_ocs_by')) {
                        return this.sort_ocs_by;
                    } else {
                        return 'default';
                    }
                },

                toggle_sort_by: function(key) {
                    if (key == 'default') {
                        // just set default
                        this.sort_ocs_by = key;
                    } else {

                        if (this.sort_ocs_by.indexOf(key)>=0) {
                            // just need to swap
                            
                            if (this.sort_ocs_by.indexOf('desc')>=0) {
                                this.sort_ocs_by = this.sort_ocs_by.replace('desc', 'asc');
                            } else {
                                this.sort_ocs_by = this.sort_ocs_by.replace('asc', 'desc');
                            }

                        } else {
                            // change to other sorting
                            this.sort_ocs_by = key + '_' + this.default_sort_ocs_order;
                        }
                    }

                },

                v_sort_ocs: function(f_ocs) {
                    var sort_by = this.get_sort_ocs_by();
                    var sort_key = sort_by.split('_')[0];

                    // a virtual list
                    var v_ocs = [];

                    for (let i = 0; i < f_ocs.length; i++) {
                        const f_oc = f_ocs[i];
                        v_ocs.push({
                            idx: i,
                            NPEt: f_oc.ma.PRIM.total[0],
                            NPNt: f_oc.ma.PRIM.total[1],
                            NPEc: f_oc.ma.PRIM.total[2],
                            NPNc: f_oc.ma.PRIM.total[3],
                            NS: f_oc.ma.PRIM.stus.length,
                            OR: f_oc.ma.PRIM.rsts.OR.random.SM,
                            RR: f_oc.ma.PRIM.rsts.RR.random.SM,
                            INCD: f_oc.ma.INCD.rsts.INCD.random.SM,
                        });
                    }

                    // now, sort
                    if (sort_by == 'default') {
                        console.log('* reset sorting ' + sort_by);
                        return v_ocs;

                    } else if (sort_by.indexOf('INCD')>=0) {
                        console.log('* sorting ' + sort_by + '|' + sort_key);

                        if (sort_by.indexOf('asc')>=0) {
                            v_ocs.sort(function(a, b) {
                                var v = 
                                    a.INCD -
                                    b.INCD
                                return v;
                            });
                        } else {
                            v_ocs.sort(function(a, b) {
                                var v = 
                                    b.INCD -
                                    a.INCD
                                return v;
                            });
                        }

                        return v_ocs;

                    } else {
                        // all other values
                        console.log('* sorting ' + sort_by + '|' + sort_key);

                        if (sort_by.indexOf('asc')>=0) {
                            v_ocs.sort((function(sort_key) {
                                return function(a, b) {
                                    var v = 
                                        a[sort_key] - 
                                        b[sort_key];
                                    return v;
                                }
                            })(sort_key));

                        } else {
                            v_ocs.sort((function(sort_key) {
                                return function(a, b) {
                                    var v = 
                                        b[sort_key] - 
                                        a[sort_key];
                                    return v;
                                }
                            })(sort_key));
                        }

                        return v_ocs;
                    } 
                },

                add_comma: function(x) {
                    x = x.toString();
                    var pattern = /(-?\d+)(\d{3})/;
                    while (pattern.test(x))
                        x = x.replace(pattern, "$1,$2");
                    return x;
                },

                index_of_f_oc: function(f_oc) {
                    for (let i = 0; i < this.f_ocs.length; i++) {
                        const x = this.f_ocs[i];
                        if (x.oc_abbr == f_oc.oc_abbr &&
                            app_filter.cmp_vals(
                                x.f_vals,
                                f_oc.f_vals
                            )) {
                                // oh, this abbr has been added
                                return i;
                            }
                        }
                
                    return -1;
                },

                add_f_oc: function(f_oc) {
                    // var f_oc = {
                    //     // basic info
                    //     oc_group: oc_group,
                    //     oc_abbr: oc_abbr,
                    //     oc_cate: oc_cate,
                    //     oc_name: oc_name,
                    //     ae_grade: ae_grade,

                    //     // filters
                    //     f_vals: f_vals,
                        
                    //     // pids
                    //     pids: pids,

                    //     // PWMA
                    //     ma: ma
                    // };
                    // check 
                    var ret = this.index_of_f_oc(f_oc);
                    if (ret>=0) {
                        return false;
                    }

                    this.f_ocs.push(
                        f_oc
                    );
                    return true;
                },

                rm_f_oc: function(f_oc_idx) {
                    this.f_ocs.splice(f_oc_idx, 1);
                },
                
                rm_all_f_ocs: function() {
                    this.f_ocs = [];
                },

                show_detail: function(f_oc) {
                    this.detail_f_oc = f_oc;

                    // ok, first, prepare the data
                    var dc = app_oclist.mk_data_cfg_by_ma(
                        f_oc.ma.PRIM,
                        'OR',
                        this.show_effect_model
                    );

                    var data = dc.data;
                    var cfg = dc.cfg;

                    // then, draw it?
                    fg_pwma_forest.draw(data, cfg);
                },

                export_f_oc: function(f_oc) {
                    if (typeof(f_oc) == 'undefined') {
                        f_oc = this.detail_f_oc;
                    }

                    if (f_oc == null) {
                        return;
                    }

                    // get all studies
                    var stus = f_oc.ma.PRIM.stus;
                    var stus_wh = [
                        [
                            'Et',
                            'Nt',
                            'Ec',
                            'Nc',
                            'study',
                            'treatment',
                            'control',
                            'pid',
                            'year'
                        ]
                    ];
                    for (let i = 0; i < stus.length; i++) {
                        const stu = stus[i];
                        stus_wh.push(stu);
                    }

                    // first, convert
                    var csv = Papa.unparse(stus_wh, {
                        quoteChar: true
                    });

                    // then download this csv
                    var blob = new Blob([csv], {type: "text/tsv;charset=utf-8"});
                    var fn = f_oc.oc_cate + '-' + f_oc.oc_name + '.csv';
                    saveAs(blob, fn);
                    
                },

                tf2: function(v) {
                    return jarvis.tf2(v);
                },

                get_ci_width_by_rst: function(d, scale) {
                    if (typeof(scale) == 'undefined') {
                        scale = 'log';
                    }
                    return this.get_ci_width(
                        d[this.show_effect_model].SM_lower,
                        d[this.show_effect_model].SM_upper,
                        scale
                    );
                },

                get_eft_left_by_rst: function(d, scale) {
                    if (typeof(scale) == 'undefined') {
                        scale = 'log'
                    }
                    var width = {
                        'one': 'lg',
                        'all': 'sm',
                    }[this.show_measure];

                    return app_comptb.x_scale[width][scale](
                        d[this.show_effect_model].SM
                    ) - 3;
                },

                get_ci_left_by_rst: function(d, scale) {
                    if (typeof(scale) == 'undefined') {
                        scale = 'log'
                    }
                    var width = {
                        'one': 'lg',
                        'all': 'sm',
                    }[this.show_measure];

                    return app_comptb.x_scale[width][scale](
                        d[this.show_effect_model].SM_lower
                    );
                },

                get_ci_width: function(lower, upper, scale) {
                    if (typeof(scale) == 'undefined') {
                        scale = 'log'
                    }
                    var width = {
                        'one': 'lg',
                        'all': 'sm',
                    }[this.show_measure];

                    return app_comptb.x_scale[width][scale](upper) - 
                           app_comptb.x_scale[width][scale](lower);
                },
                
                get_eft_color: function(d) {
                    return jarvis.get_color(
                        d[this.show_effect_model].SM,
                        d[this.show_effect_model].SM_lower,
                        d[this.show_effect_model].SM_upper,
                    )
                    // if (d.random.SM < 1) {
                    //     if (d.random.SM_upper < 1) {
                    //         return jarvis.color.bene.sig;
                    //     } else {
                    //         return jarvis.color.bene.not;
                    //     }
                    // } else{

                    //     if (d.random.SM_lower > 1) {
                    //         return jarvis.color.harm.sig;
                    //     } else {
                    //         return jarvis.color.harm.not;
                    //     }
                    // }
                }
            },
            mounted: function() {
                if (this.f_ocs.length > 0) {

                }
            }
        });
    }
};


var app_sclist = {
    vpp: null,
    vpp_id: '#app_sclist',

    init: function() {
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                // the full ocs for comparison
                scs: [],
            },
            methods: {
                add: function() {
                    // first, get the image
                    var img_src = vis_ocmas.fig_sunburst.getDataURL({
                        pixelRatio: 0.5,
                        backgroundColor: '#fff'
                    });

                    // then, get all values
                    var filter_vals = app_filter.vpp.get_current_values();

                    // save this scenario
                    this.scs.push({
                        img_src: img_src,
                        filter_vals: filter_vals
                    });
                },

                rm: function(sc_idx) {
                    this.scs.splice(sc_idx, 1);
                },

                rm_all: function() {
                    this.scs = [];
                },

                load: function(sc) {
                    app_filter.vpp.set_values(
                        sc.filter_vals
                    );
                }
            }
        });
    }
}


var app_detail = {
};


var vis_ocmas = {
    fig_scatter: null,
    fig_scatter_id: 'fig_scatter',
    fig_scatter_options: null,
    fig_scatter_schema: [
        { attr: 'INCD', text: 'Incidence', index: 0 },
        { attr: 'OR', text: 'Odds Ratio', index: 1 },
        { attr: 'name', text: 'Outcome Name', index: 2 },
        { attr: 'grade', text: 'AE Grade', index: 3 },
        { attr: 'OR_n_stus', text: '# of Studies', index: 4 },
        { attr: 'OR_lower', text: 'OR lower', index: 5 },
        { attr: 'OR_upper', text: 'OR upper', index: 6 },
        { attr: 'INCD_lower', text: 'INCD lower', index: 7 },
        { attr: 'INCD_upper', text: 'INCD upper', index: 8 },
    ],

    fig_sunburst: null,
    fig_sunburst_id: 'fig_sunburst',
    fig_sunburst_options: null,

    fig_heatmap: null,
    fig_heatmap_id: '#fig_heatmap',
    
    init: function() {
        this.init_fig_scatter();
        this.init_fig_sunburst();
        this.init_fig_heatmap();
    },

    init_fig_sunburst: function() {
        this.fig_sunburst = echarts.init(
            document.getElementById(this.fig_sunburst_id)
        );
        this.fig_sunburst_options = {
            series: {
                radius: ['15%', '80%'],
                type: 'sunburst',
                sort: undefined,
                emphasis: {
                    focus: 'descendant',
                    label: {
                        show: true,
                        formatter: '{b}'
                    }
                },
                data: [],
                label: {
                    rotate: 'radial',
                    fontSize: 8,
                    show: false
                },
                nodeClick: false,
                levels: [
                    {},
                    // group level
                    {
                        r0: 40,
                        r:  85, 
                        label: {
                            fontSize: 14,
                            rotate: 0,
                            show: true
                        }
                    },
                    // cate level
                    {
                        r0: 90,
                        r:  150,
                        label: {
                            fontSize: 9,
                            show: true,
                            minAngle: 5
                        }
                    },
                    // oc level
                    {
                        r0: 155,
                        r:  170,
                        label: {
                            fontSize: 10,
                            show: true,
                            minAngle: 5
                        }
                    },
                    // GA level
                    {
                        r0: 170,
                        r:  210,

                        emphasis: {
                            label: {
                                show: true
                            }
                        }
                    },
                    // G3H level
                    {
                        r0: 215,
                        r:  255
                    },
                    // G5 level
                    {
                        r0: 260,
                        r:  300
                    }
                ],
                itemStyle: {
                    color: '#ddd',
                    borderWidth: 1
                }
            }
        };

        // Display the chart using the configuration items and data just specified.
        this.fig_sunburst.setOption(
            this.fig_sunburst_options
        );

        // bind event
        this.fig_sunburst.on('click', function(params) {
            console.log('* clicked on sunburst', params);

            // add this 
            if (params.data.level == 'rst') {
                // which means it's a leaf level
                jarvis.add_oc(
                    params.data.oc_info.oc_group, 
                    params.data.oc_info.oc_cate, 
                    params.data.oc_info.oc_name, 
                    params.data.oc_info.oc_abbr, 
                    params.data.grade, 

                    app_oclist.pids
                );
                return false;

            } else {

            }
        });
    },

    init_fig_heatmap: function() {
        this.fig_heatmap = new Vue({
            el: this.fig_heatmap_id,
            data: {
                oc_dict3: {}
            },
            methods: {
                get_fh_c_cls: function(cate) {
                    var n_ocs = Object.values(cate).length;

                    if (n_ocs <= 25) {
                        return 'fh-c-5';

                    } else if (n_ocs <= 64) {
                        return 'fh-c-8';

                    } else {
                        return 'fh-c-10';
                    }
                },

                get_oc_short_name: function(oc_name) {
                    var vs = oc_name.split(' ');
                    if (vs.length == 1) {
                        // Hmmm just one word
                        return vs[0].substring(0, 2);

                    } else {
                        return vs[0][0] + vs[1][0];
                    }
                }
            }
        });
    },

    init_fig_scatter: function() {
        this.fig_scatter = echarts.init(
            document.getElementById(this.fig_scatter_id)
        );
        this.fig_scatter_options = {
            tooltip: {
                backgroundColor: 'rgba(255,255,255,0.7)',
                formatter: function (param) {
                    var value = param.value;
                    // prettier-ignore
                    return '<div class="fig-tooltip-header">' +
                        // param.seriesName + ' ' + value[2] + '日：' +
                        value[2] + ': ' +
                        '</div>' +
                        vis_ocmas.fig_scatter_schema[3].text + ': ' + value[3] + '<br>' +
                        vis_ocmas.fig_scatter_schema[4].text + ': ' + value[4] + '<br>' +
                        vis_ocmas.fig_scatter_schema[0].text + ': ' + jarvis.tf2(value[0]) + '<br>' +
                        vis_ocmas.fig_scatter_schema[1].text + ': ' + jarvis.tf2(value[1]) + '<br>';
                }
            },
            legend: {},
            toolbox: {
                show: true,
                feature: {
                    dataZoom: {
                    },
                    dataView: { readOnly: false },
                    saveAsImage: {}
                }
            },
            xAxis: {
                type: 'value',
                name: 'Incidence',
                // max: 0.5
            },
            yAxis: {
                type: 'value',
                name: 'Odds Ratio',
                max: 10
            },
            series: [
                {
                    name: 'PMA GA',
                    type: 'scatter',
                    data: [],
                    symbolSize: vis_ocmas.to_symbol_size
                },

                {
                    name: 'PMA G3H',
                    type: 'scatter',
                    data: [],
                    symbolSize: vis_ocmas.to_symbol_size
                },

                {
                    name: 'PMA G5N',
                    type: 'scatter',
                    data: [],
                    symbolSize: vis_ocmas.to_symbol_size
                }
            ]
        };

        // Display the chart using the configuration items and data just specified.
        this.fig_scatter.setOption(
            this.fig_scatter_options
        );
    },

    draw_fig_scatter: function(ds) {
        this.fig_scatter.setOption({
            series: [{
                data: ds.data_ga
            }, {
                data: ds.data_g3h
            }, {
                data: ds.data_g5n
            }]
        });
    },

    draw_fig_heatmap: function(oc_dict3) {
        this.fig_heatmap.$data.oc_dict3 = oc_dict3;
    },

    draw_fig_sunburst: function(oc_dict3, ma_dict) {
        var data = [];
        const itemStyle_NA = { color: '#fefefe' };
        const itemStyle_harm_sig = { color: jarvis.color.harm.sig };
        const itemStyle_harm_not = { color: jarvis.color.harm.not };
        const itemStyle_bene_sig = { color: jarvis.color.bene.sig };
        const itemStyle_bene_not = { color: jarvis.color.bene.not };

        for (const group_name in oc_dict3) {
            var group = oc_dict3[group_name];
            
            // object for this group
            var d_g = {
                name: group_name,
                oc_info: null,
                level: 'gp',
                value: 0,
                itemStyle: {
                    color: jarvis.color.group[group_name]
                },
                children: []
            };

            for (const cate_name in group) {
                var cate = group[cate_name];

                // object for this cate
                var d_c = {
                    name: cate_name,
                    oc_info: null,
                    level: 'cate',
                    value: 0,
                    itemStyle: {
                        color: jarvis.color.cate_by_group[group_name]
                    },

                    children: []
                };

                for (const oc_abbr in cate) {
                    var oc = cate[oc_abbr];

                    // object for this oc
                    var itemStyle_g = {
                        GA: itemStyle_NA,
                        G3H: itemStyle_NA,
                        G5N: itemStyle_NA
                    }

                    var child_name = {
                        // GA: oc.oc_name,
                        // G3H: oc.oc_name,
                        // G5N: oc.oc_name,
                        GA: '',
                        G3H: '',
                        G5N: '',
                    }

                    if (ma_dict.hasOwnProperty(oc_abbr)) {
                        for (let i = 0; i < 3; i++) {
                            var grade = {0: 'GA', 1: 'G3H', 2: 'G5N'}[i];
                            
                            if (ma_dict[oc_abbr][grade].PRIM.stus.length > 0) {
                                // if (ma_dict[oc_abbr][grade].PRIM.rsts.OR.random.SM < 1) {
                                //     itemStyle_g[grade] = {
                                //         color
                                //     };
                                // } else {
                                //      = itemStyle_harm;
                                // }
                                itemStyle_g[grade] = {
                                    color: jarvis.get_color(
                                        ma_dict[oc_abbr][grade].PRIM.rsts.OR.random.SM,
                                        ma_dict[oc_abbr][grade].PRIM.rsts.OR.random.SM_lower,
                                        ma_dict[oc_abbr][grade].PRIM.rsts.OR.random.SM_upper
                                    )
                                }

                                // update name
                                child_name[grade] = 
                                    oc.oc_name + 
                                    ': ' +
                                    jarvis.tf2(ma_dict[oc_abbr][grade].PRIM.rsts.OR.random.SM);
                            } else {
                                
                            }
                        }
                    } else {
                        
                    }

                    var d_o = {
                        name: oc.oc_name,
                        oc_info: null,
                        level: 'oc',
                        value: 1,
                        itemStyle: {
                            color: '#FFFFFF'
                        },
                        children: [{
                            name: child_name.GA,
                            oc_info: oc,
                            level: 'rst',
                            grade: 'GA',
                            value: 1,
                            itemStyle: itemStyle_g.GA,
                            children: [{
                                name: child_name.G3H,
                                oc_info: oc,
                                level: 'rst',
                                grade: 'G3H',
                                itemStyle: itemStyle_g.G3H,
                                value: 1,
                                children: [{
                                    name: child_name.G5N,
                                    oc_info: oc,
                                    level: 'rst',
                                    grade: 'G5N',
                                    itemStyle: itemStyle_g.G5N,
                                    value: 1
                                }]
                            }]
                        }]
                    }

                    // increase the count of this cate
                    d_c.value += 1;

                    // increase the count of this group
                    d_g.value += 1;

                    // append this oc to current cate
                    d_c.children.push(d_o);
                }

                // append this cate to current group
                d_g.children.push(d_c);
            }

            // append this group to data
            data.push(d_g);
        }

        this.fig_sunburst.setOption({
            series: [{
                data: data
            }]
        });
    },

    to_symbol_size: function(vals) {
        return math.sqrt(vals[4]) * 2 + 1;
    }
};


var jarvis = {
    color: {
        group: {
            treatment: '#5CC8FF',
            immune: '#DEC1FF'
        },
        cate_by_group: {
            treatment: '#EBF8FF',
            immune: '#F4EBFF'
        },
        bene: {
            sig: '#0cab0c',
            not: '#c7ffc7'
        },
        harm: {
            sig: '#ff3a3a',
            not: '#ffe0e5'
        }
    },

    get_color: function(SM, SM_lower, SM_upper) {
        if (SM < 1) {
            if (SM_upper < 1) {
                return this.color.bene.sig;
            } else {
                return this.color.bene.not;
            }
        } else{

            if (SM_lower > 1) {
                return this.color.harm.sig;
            } else {
                return this.color.harm.not;
            }
        }
    },

    texts: {
        "GA": "All Grade",
        "G34": "Grade 3/4",
        "G3H": "Grade 3 or higher",
        "G5N": "Grade 5 only"
    },

    capitalize: function(s) {
        return s.charAt(0).toUpperCase() + s.slice(1);
    },
    
    init: function() {
        var isIE = /*@cc_on!@*/false || !!document.documentMode;

        console.log('* User is using IE:', isIE);
        if (isIE) {
            jarvis.ssmsg('The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.')
            return;
        }

        // OK, 
        var prj = jarvis.get_url_paramter('prj');
        if (prj == null) {
            jarvis.ssmsg('Project information error.')
            return;
        }

        prj = 'IO';

        var src = jarvis.get_url_paramter('src');
        if (src == null || src == '') {
            src = 'cache';
        }

        // set the app_oclist to radio button model
        app_oclist.select_mode = 'radio';

        var cq = jarvis.get_url_paramter('cq');
        if (cq == '') {
            cq = 'default';
        }

        // just init the plots
        vis_ocmas.init();

        // just init the app_comptb
        app_comptb.init();

        // just init the app_sclist
        app_sclist.init();

        // load all data
        $.when(
            $.get(
                './static/data/IO_ITABLE.json',
                // {rnd: Math.random(), src: src, cq: cq},
                {src: src, cq: cq},
            ),
            $.get(
                './static/data/IO_GRAPH_PMA.json',
                // {ver: Math.random(), src: src, cq: cq},
                {src: src, cq: cq},
            )
        ).done(function(r1, r2) {
            var data1 = r1[0];
            var data2 = r2[0];

            jarvis.data1 = data1;
            jarvis.data2 = data2;

            // init the table
            console.log(data1);
            console.log(data2);

            // init the local db for the papers
            alasql('create table papers');
            alasql('select * into papers from ?', [data1.rs]);
            
            // init the local db for the outcome / AE records
            alasql('create table aes');
            alasql('select * into aes from ?', [data2.rs])

            // init a dict for searching


            // init the filter with ITABLE data
            app_filter.init(data1);

            // init the list and plots with outcome data
            app_oclist.init(data2);
            // vw_ocplot.init(data2);

            // ok, remove the 
            jarvis.ssmsg('Almost initialized.');
            setTimeout('jarvis.ssclose();', 400);

            // app_filter.vpp.set_values(
            //     ['PD1', 'all', 'Monotherapy', '%', 'Chemo', 'all']
            // );
            // jarvis.set_mode(4);
        });

        
    },

    update_plots_by_pmids: function(pmids) {
        app_oclist.update(pmids);
    },

    get_url_paramter: function(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    },

    add_oc: function(oc_group, oc_cate, oc_name, oc_abbr, ae_grade, pids) {
        // console.log('* add_oc ' + oc_group + ' | ' + oc_cate + ' | ' +oc_abbr+' , ' + oc_name + ', ' + ae_grade, pids);
        // vw_ocplot.show_plot(group, oc_cate, oc_name, ae_grade, pids);

        // first, get the filter values
        var f_vals = app_filter.vpp.get_current_values();

        // second, get the raw data and the ma rst
        var ma = app_oclist.ma_dict[oc_abbr][ae_grade];

        // then, create a f_oc and push to cmp
        var f_oc = {
            // basic info
            oc_group: oc_group,
            oc_abbr: oc_abbr,
            oc_cate: oc_cate,
            oc_name: oc_name,
            ae_grade: ae_grade,

            // filters
            f_vals: f_vals,
            
            // pids
            pids: pids,

            // PWMA
            ma: ma
        };

        var ret = app_comptb.vpp.add_f_oc(f_oc);
        if (ret) {
            // ok, added
            console.log('* added f_oc: ', f_oc);
            return 1;
        } else {
            // no this is a duplicated
            console.log('* skipped adding f_oc:', f_oc);
            return 0;
        }
    },

    clear_all_ae: function() {

    },

    ssmsg: function(msg) {
        $('#ss-msg').html(msg);
    },

    ssclose: function() {
        $('#start-screen').hide();
    },

    tf2: function(v) {
        if (isNaN(v)) {
            return 'NA';
        } 
        return v.toFixed(2);
    },

    set_mode: function(mode) {
        if (typeof(mode) == 'undefined') {
            mode = 0;
        }
        if (mode == 0) {
            this.set_mode(1);
            this.set_mode(3);
        }
        if (mode == 1) {
            $('#app_comptb_box').height('calc(50% - 20px)');
            $('#app_detail_box').height('calc(50% - 20px)');
        }
        if (mode == 2) {
            $('#app_comptb_box').height('calc(100% - 150px)');
            $('#app_detail_box').height('20px');
        }
        if (mode == 3) {
            $('#show_overview').hide();
            $('#vw_ocplot').show();
            $('#app_comptb').width('auto');
        }
        if (mode == 4) {
            $('#vw_ocplot').hide();
            $('#show_overview').show();
            $('#app_comptb').width('calc(100% - 300px)');
        }
    }
};

$(document).ready(function() {
    jarvis.init();
})
</script>
</body>